package com.tekion.accounting.fs.service.compute;

import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Sets;
import com.tekion.accounting.fs.beans.accountingInfo.AccountingInfo;
import com.tekion.accounting.fs.beans.common.*;
import com.tekion.accounting.fs.beans.mappings.*;
import com.tekion.accounting.fs.beans.memo.FieldType;
import com.tekion.accounting.fs.beans.memo.HCWorksheet;
import com.tekion.accounting.fs.beans.memo.MemoValue;
import com.tekion.accounting.fs.beans.memo.MemoWorksheet;
import com.tekion.accounting.fs.common.GlobalService;
import com.tekion.accounting.fs.common.TConstants;
import com.tekion.accounting.fs.common.dpProvider.DpUtils;
import com.tekion.accounting.fs.common.enums.CustomFieldType;
import com.tekion.accounting.fs.common.utils.*;
import com.tekion.accounting.fs.dto.cellGrouop.FSCellGroupCodeCreateDto;
import com.tekion.accounting.fs.dto.cellGrouop.FSCellGroupCodesCreateDto;
import com.tekion.accounting.fs.dto.cellGrouop.FsGroupCodeDetail;
import com.tekion.accounting.fs.dto.cellGrouop.FsGroupCodeDetailsResponseDto;
import com.tekion.accounting.fs.dto.cellcode.*;
import com.tekion.accounting.fs.dto.context.FsReportContext;
import com.tekion.accounting.fs.dto.fsEntry.FsEntryCreateDto;
import com.tekion.accounting.fs.dto.mappings.*;
import com.tekion.accounting.fs.dto.oemConfig.OemConfigRequestDto;
import com.tekion.accounting.fs.dto.oemTemplate.OemTemplateReqDto;
import com.tekion.accounting.fs.dto.oemTemplate.TemplateDetail;
import com.tekion.accounting.fs.enums.*;
import com.tekion.accounting.fs.repos.*;
import com.tekion.accounting.fs.repos.worksheet.HCWorksheetRepo;
import com.tekion.accounting.fs.repos.worksheet.MemoWorksheetRepo;
import com.tekion.accounting.fs.service.accountingInfo.AccountingInfoService;
import com.tekion.accounting.fs.service.accountingService.AccountingService;
import com.tekion.accounting.fs.service.common.cache.CustomFieldConfig;
import com.tekion.accounting.fs.service.common.cache.dtos.OptionMinimal;
import com.tekion.accounting.fs.service.compute.models.CellCodeKey;
import com.tekion.accounting.fs.service.compute.models.OemFsCellContext;
import com.tekion.accounting.fs.service.compute.models.OemFsMappingSimilarToUI;
import com.tekion.accounting.fs.service.fsEntry.FsEntryService;
import com.tekion.accounting.fs.service.tasks.ConsolidatedFsGlBalanceReportInEpochTask;
import com.tekion.accounting.fs.service.utils.FinancialStatementUtils;
import com.tekion.as.client.AccountingClient;
import com.tekion.as.models.beans.GLAccount;
import com.tekion.as.models.beans.MediaResponse;
import com.tekion.as.models.beans.TrialBalance;
import com.tekion.as.models.beans.TrialBalanceRow;
import com.tekion.as.models.beans.fs.FsReportDto;
import com.tekion.as.models.dto.MonthInfo;
import com.tekion.beans.DynamicProperty;
import com.tekion.core.exceptions.TBaseRuntimeException;
import com.tekion.core.utils.TCollectionUtils;
import com.tekion.core.utils.TStringUtils;
import com.tekion.core.utils.UserContextProvider;
import com.tekion.core.validation.TValidator;
import com.tekion.propertyclient.DPClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.bson.types.ObjectId;
import org.joda.time.DateTime;
import org.joda.time.DateTimeZone;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.core.task.AsyncTaskExecutor;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;
import java.math.BigDecimal;
import java.time.Month;
import java.time.YearMonth;
import java.util.*;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Future;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

import static com.tekion.accounting.fs.beans.common.AccountingOemFsCellCode.additionInfoField_codeIdentifier;
import static com.tekion.accounting.fs.beans.common.AccountingOemFsCellCode.additionInfoField_month;
import static com.tekion.accounting.fs.common.AsyncContextDecorator.ASYNC_THREAD_POOL;
import static com.tekion.accounting.fs.common.TConstants.ACCOUNTING_MODULE;
import static com.tekion.core.utils.UserContextProvider.getCurrentDealerId;
import static com.tekion.core.utils.UserContextProvider.getCurrentTenantId;
import static java.util.stream.Collectors.groupingBy;

@Component
@Slf4j
@RequiredArgsConstructor
public class FsComputeServiceImpl implements FsComputeService {
	private final OEMFinancialMappingRepository oemFSMappingRepo;
	private final OEMFinancialMappingMediaRepository oemFSMediaRepo;
	private final TValidator validator;
	private final OemFSMappingRepo oemFsMappingRepo;
	private final FSCellCodeRepo fsCellCodeRepo;
	private final OemTemplateRepo oemTemplateRepo;
	private final OemFsCellGroupRepo oemFsCellGroupRepo;
	private final MemoWorksheetRepo memoWorksheetRepo;
	private final HCWorksheetRepo hcWorksheetRepo;
	private final OEMFsCellCodeSnapshotRepo oemFsCellCodeSnapshotRepo;
	private final OemFsMappingSnapshotRepo oemFsMappingSnapshotRepo;
	private final DealerConfig dealerConfig;
	private final OemConfigRepo oemConfigRepo;
	private final AccountingInfoService aiService;
	private final DPClient dpClient;
	public final FsEntryService fsEntryService;
	public final FSEntryRepo fsEntryRepo;
	public final GlobalService globalService;
	public final AccountingClient accountingClient;
	public final AccountingService accountingService;
	public final CustomFieldConfig customFieldConfig;


	@Qualifier(ASYNC_THREAD_POOL)
	@Autowired
	private AsyncTaskExecutor executorService;

	private LoadingCache<CellCodeKey, List<AccountingOemFsCellCode>> accountingOemFsCellCodesCache;
	private static final String DEFAULT_ROUND_OFF = "";
	private static final String ENABLE_ROUND_OFF = "YES";
	private static final String DISABLE_ROUND_OFF = "NO";
	private static final String FS_ROUND_OFF_PROPERTY = "FS_USE_PRECISION";
	private static final String OFFSET_VALUE = "offset";
	private static final String ORIGINAL_VALUE = "original";
	private static final String ROUNDED_VALUE = "rounded";
	private static final String SOURCE_TYPE = "sourceType";
	public static final String NCT_DATE_FORMAT = "dd-MMM-yy";

	private DynamicProperty<String> dealerRoundOffPref;

	private final int defaultMonth = 0;

	@PostConstruct
	public void postConstruct(){
		accountingOemFsCellCodesCache = CacheBuilder.newBuilder()
				.expireAfterWrite(30, TimeUnit.MINUTES).maximumSize(5)
				.build(new CacheLoader<CellCodeKey, List<AccountingOemFsCellCode>>() {
					@Override
					public List<AccountingOemFsCellCode> load(CellCodeKey key) {
						return getOemTMappingList(key.getOemId(), key.getYear(),key.getVersion(), key.getCountryCode());
					}
				});
		dealerRoundOffPref = dpClient.getStringProperty(ACCOUNTING_MODULE, FS_ROUND_OFF_PROPERTY);
	}

	@Override
	public void saveMapping(OemMappingRequestDto mappingRequest) {
		validator.validate(mappingRequest);
		List<OEMMappingDto> mappings= TCollectionUtils
				.nullSafeList(mappingRequest.getMappings());

		List<OEMFinancialMapping> mappingsToDelete = mappings.stream().filter(m -> {
			return m.getId() != null && m.getOemAccountNumber() == null;
		}).map(m -> fromDto(m, mappingRequest)).collect(Collectors.toList());

		List<OEMFinancialMapping> mappingsToUpdate = mappings.stream().filter(m -> {
			return m.getOemAccountNumber() != null;
		}).map(mapping -> fromDto(mapping, mappingRequest)).collect(Collectors.toList());
		if(TCollectionUtils.isNotEmpty(mappingsToDelete)){
			oemFSMappingRepo.deleteMappings(mappingsToDelete);
		}

		if(TCollectionUtils.isNotEmpty(mappingsToUpdate)) {
			oemFSMappingRepo.upsertMappings(mappingsToUpdate);
		}

		FSEntry fsEntry = fsEntryRepo.findByIdAndDealerIdWithNullCheck(mappingRequest.getFsId(), mappingRequest.getDealerId());
		if(mappingRequest.getMedias() != null){
			OEMFinancialMappingMedia oemMappingMedia = OEMFinancialMappingMedia.builder()
					.dealerId(mappingRequest.getDealerId())
					.medias(mappingRequest.getMedias())
					.fsId(mappingRequest.getFsId()).build();

			OEMFinancialMappingMedia savedMedia = oemFSMediaRepo
					.findSavedMediaByDealerIdNonDeleted(fsEntry.getOemId(), fsEntry.getYear().toString(), mappingRequest.getDealerId());
			if(savedMedia!=null){
				oemMappingMedia.setId(savedMedia.getId());
			}
			oemFSMediaRepo.saveMedia(oemMappingMedia);
		}
	}

	@Override
	public OEMMappingResponse getOEMMappingByDealerId(OEM oem, String dealerId, String year) {
		OEMFinancialMappingMedia savedMedia = oemFSMediaRepo
				.findSavedMediaByDealerIdNonDeleted(oem.name(), year, dealerId);
		List<MediaResponse> medias = null;
		if(savedMedia != null){
			medias = savedMedia.getMedias();
		}

		List<OEMFinancialMapping> mappings = oemFSMappingRepo
				.findMappingsByFsIdAndDealerId(year, getCurrentDealerId());
		return OEMMappingResponse.builder()
				.mappings(mappings)
				.medias(medias)
				.build();
	}


//    @Override
//    public List<String> getOemTMappingList(OEM oem) {
//        return Lists.newArrayList("230GM-UNIT","231GM-UNIT","237GM-UNIT","235GM-UNIT","230GM-FIFO","231GM-FIFO","237GM-FIFO","235GM-FIFO","230GM-LIFOWD","231GM-LIFOWD","237GM-LIFOWD","235GM-LIFOWD","230OTH-UNIT","231OTH-UNIT","237OTH-UNIT","235OTH-UNIT","TOTINVEN-01-UNIT","230OTH-FIFO","231OTH-FIFO","237OTH-FIFO","235OTH-FIFO","238OTH-FIFO","230OTH-LIFOWD","231OTH-LIFOWD","237OTH-LIFOWD","235OTH-LIFOWD","238OTH-LIFOWD","240UND45-FIFO","241UND45-FIFO","240OVR45-FIFO","241OVR45-FIFO","240UND45-UNIT","241UND45-UNIT","240OVR45-UNIT","241OVR45-UNIT","TOTINVEN-02-UNIT","240TOTL-LIFOWD","241TOTL-LIFOWD","242GM-FIFO","242AGM-FIFO","243GM-FIFO","244GM-FIFO","245GM-FIFO","258GM-FIFO","242GM-LIFOWD","243GM-LIFOWD","244GM-LIFOWD","245GM-LIFOWD","258GM-LIFOWD","242OTH-FIFO","242AOTH-FIFO","243OTH-FIFO","244OTH-FIFO","245OTH-FIFO","258OTH-FIFO","242OTH-LIFOWD","243OTH-LIFOWD","244OTH-LIFOWD","245OTH-LIFOWD","258OTH-LIFOWD","TOTRES-LIFOWD","247A-AMT","247B-AMT","210VEH-31-60D","210OTH-31-60D","220VEH-31-60D","220SVCPT-31-60D","220OTH-31-60D","210VEH-61-90D","210OTH-61-90D","220VEH-61-90D","220SVCPT-61-90D","220OTH-61-90D","210VEH-OVER90D","210OTH-OVER90D","220VEH-OVER90D","220SVCPT-OVER90D","220OTH-OVER90D","CASH-SALES","OWNR-01-PERSONNL","SUPV-01-PERSONNL","SALES-01-PERSONNL","CLERC-01-PERSONNL","OTHR-01-PERSONNL","HIRED-01-PERSONNL","TERM-01-PERSONNL","OWNR-02-PERSONNL","SUPV-02-PERSONNL","SALES-02-PERSONNL","CLERC-02-PERSONNL","OTHR-02-PERSONNL","HIRED-02-PERSONNL","TERM-02-PERSONNL","OWNR-03-PERSONNL","SUPV-03-PERSONNL","SALES-03-PERSONNL","CLERC-03-PERSONNL","OTHR-03-PERSONNL","HIRED-03-PERSONNL","TERM-03-PERSONNL","SUPV-04-PERSONNL","CLERC-04-PERSONNL","OTHR-04-PERSONNL","HIRED-04-PERSONNL","TERM-04-PERSONNL","OWNR-05-PERSONNL","SUPV-05-PERSONNL","SALES-05-PERSONNL","TECH-05-PERSONNL","CLERC-05-PERSONNL","OTHR-05-PERSONNL","HIRED-05-PERSONNL","TERM-05-PERSONNL","OWNR-06-PERSONNL","SUPV-06-PERSONNL","SALES-06-PERSONNL","TECH-06-PERSONNL","CLERC-06-PERSONNL","OTHR-06-PERSONNL","HIRED-06-PERSONNL","TERM-06-PERSONNL","OWNR-07-PERSONNL","SUPV-07-PERSONNL","SALES-07-PERSONNL","CLERC-07-PERSONNL","OTHR-07-PERSONNL","HIRED-07-PERSONNL","TERM-07-PERSONNL","OWNR-09-PERSONNL","SUPV-09-PERSONNL","SALES-09-PERSONNL","TECH-09-PERSONNL","CLERC-09-PERSONNL","OTHR-09-PERSONNL","HIRED-09-PERSONNL","TERM-09-PERSONNL","TOTAL-PERSONNL","HIRED-PERSONNL","TERM-PERSONNL","275-UNIT","277-UNIT","285CAR-UNIT","285TRK-UNIT","310DP-AMT","NWC-QLTD","NWC-STANDARD","460A-05-LABORATE","460B-05-LABORATE","460C-05-LABORATE","461A-05-LABORATE","461B-05-LABORATE","461C-05-LABORATE","462-05-LABORATE","463-05-LABORATE","472-06-LABORATE","473-06-LABORATE","470-06-LABORATE","471-06-LABORATE","419A-01-SALES","419B-01-SALES","419C-01-SALES","419D-01-SALES","419E-01-SALES","419F-01-SALES","419G-01-SALES","419H-01-SALES","419I-01-SALES","419J-01-SALES","439A-01-SALES","439B-01-SALES","439C-01-SALES","439D-01-SALES","439E-01-SALES","439F-01-SALES","439G-01-SALES","439H-01-SALES","439I-01-SALES","439J-01-SALES","619A-01-COS","619B-01-COS","619C-01-COS","619D-01-COS","619E-01-COS","619F-01-COS","619G-01-COS","619H-01-COS","619I-01-COS","619J-01-COS","639A-01-COS","639B-01-COS","639C-01-COS","639D-01-COS","639E-01-COS","639F-01-COS","639G-01-COS","639H-01-COS","639I-01-COS","639J-01-COS","400A-01-UNIT","401A-01-UNIT","402A-01-UNIT","403A-01-UNIT","404A-01-UNIT","405A-01-UNIT","406A-01-UNIT","407A-01-UNIT","408A-01-UNIT","409A-01-UNIT","410A-01-UNIT","411A-01-UNIT","412A-01-UNIT","413A-01-UNIT","414A-01-UNIT","415A-01-UNIT","416A-01-UNIT","417A-01-UNIT","418A-01-UNIT","419A-01-UNIT","420A-01-UNIT","421A-01-UNIT","423A-01-UNIT","424A-01-UNIT","425A-01-UNIT","426A-01-UNIT","427A-01-UNIT","428A-01-UNIT","429A-01-UNIT","430A-01-UNIT","431A-01-UNIT","432A-01-UNIT","433A-01-UNIT","434A-01-UNIT","435A-01-UNIT","436A-01-UNIT","437A-01-UNIT","438A-01-UNIT","439A-01-UNIT","440A-01-UNIT","441A-01-UNIT","457A-01-UNIT","TOTVEHA-01-UNIT","400B-01-UNIT","401B-01-UNIT","402B-01-UNIT","403B-01-UNIT","404B-01-UNIT","405B-01-UNIT","406B-01-UNIT","407B-01-UNIT","408B-01-UNIT","409B-01-UNIT","410B-01-UNIT","411B-01-UNIT","412B-01-UNIT","413B-01-UNIT","414B-01-UNIT","415B-01-UNIT","416B-01-UNIT","417B-01-UNIT","418B-01-UNIT","419B-01-UNIT","420B-01-UNIT","421B-01-UNIT","423B-01-UNIT","424B-01-UNIT","425B-01-UNIT","426B-01-UNIT","427B-01-UNIT","428B-01-UNIT","429B-01-UNIT","430B-01-UNIT","431B-01-UNIT","432B-01-UNIT","433B-01-UNIT","434B-01-UNIT","435B-01-UNIT","436B-01-UNIT","437B-01-UNIT","438B-01-UNIT","439B-01-UNIT","440B-01-UNIT","441B-01-UNIT","457B-01-UNIT","TOTVEHB-01-UNIT","400C-01-UNIT","401C-01-UNIT","402C-01-UNIT","403C-01-UNIT","404C-01-UNIT","405C-01-UNIT","406C-01-UNIT","407C-01-UNIT","408C-01-UNIT","409C-01-UNIT","410C-01-UNIT","411C-01-UNIT","412C-01-UNIT","413C-01-UNIT","414C-01-UNIT","415C-01-UNIT","416C-01-UNIT","417C-01-UNIT","418C-01-UNIT","419C-01-UNIT","420C-01-UNIT","421C-01-UNIT","423C-01-UNIT","424C-01-UNIT","425C-01-UNIT","426C-01-UNIT","427C-01-UNIT","428C-01-UNIT","429C-01-UNIT","430C-01-UNIT","431C-01-UNIT","432C-01-UNIT","433C-01-UNIT","434C-01-UNIT","435C-01-UNIT","436C-01-UNIT","437C-01-UNIT","438C-01-UNIT","439C-01-UNIT","440C-01-UNIT","441C-01-UNIT","457C-01-UNIT","TOTVEHC-01-UNIT","400D-01-UNIT","401D-01-UNIT","402D-01-UNIT","403D-01-UNIT","404D-01-UNIT","405D-01-UNIT","406D-01-UNIT","407D-01-UNIT","408D-01-UNIT","409D-01-UNIT","410D-01-UNIT","411D-01-UNIT","412D-01-UNIT","413D-01-UNIT","414D-01-UNIT","415D-01-UNIT","416D-01-UNIT","417D-01-UNIT","418D-01-UNIT","419D-01-UNIT","420D-01-UNIT","421D-01-UNIT","423D-01-UNIT","424D-01-UNIT","425D-01-UNIT","426D-01-UNIT","427D-01-UNIT","428D-01-UNIT","429D-01-UNIT","430D-01-UNIT","431D-01-UNIT","432D-01-UNIT","433D-01-UNIT","434D-01-UNIT","435D-01-UNIT","436D-01-UNIT","437D-01-UNIT","438D-01-UNIT","439D-01-UNIT","440D-01-UNIT","441D-01-UNIT","457D-01-UNIT","TOTVEHD-01-UNIT","400E-01-UNIT","401E-01-UNIT","402E-01-UNIT","403E-01-UNIT","404E-01-UNIT","405E-01-UNIT","406E-01-UNIT","407E-01-UNIT","408E-01-UNIT","409E-01-UNIT","410E-01-UNIT","411E-01-UNIT","412E-01-UNIT","413E-01-UNIT","414E-01-UNIT","415E-01-UNIT","416E-01-UNIT","417E-01-UNIT","418E-01-UNIT","419E-01-UNIT","420E-01-UNIT","421E-01-UNIT","423E-01-UNIT","424E-01-UNIT","425E-01-UNIT","426E-01-UNIT","427E-01-UNIT","428E-01-UNIT","429E-01-UNIT","430E-01-UNIT","431E-01-UNIT","432E-01-UNIT","433E-01-UNIT","434E-01-UNIT","435E-01-UNIT","436E-01-UNIT","437E-01-UNIT","438E-01-UNIT","439E-01-UNIT","440E-01-UNIT","441E-01-UNIT","457E-01-UNIT","TOTVEHE-01-UNIT","400F-01-UNIT","401F-01-UNIT","402F-01-UNIT","403F-01-UNIT","404F-01-UNIT","405F-01-UNIT","406F-01-UNIT","407F-01-UNIT","408F-01-UNIT","409F-01-UNIT","410F-01-UNIT","411F-01-UNIT","412F-01-UNIT","413F-01-UNIT","414F-01-UNIT","415F-01-UNIT","416F-01-UNIT","417F-01-UNIT","418F-01-UNIT","419F-01-UNIT","420F-01-UNIT","421F-01-UNIT","423F-01-UNIT","424F-01-UNIT","425F-01-UNIT","426F-01-UNIT","427F-01-UNIT","428F-01-UNIT","429F-01-UNIT","430F-01-UNIT","431F-01-UNIT","432F-01-UNIT","433F-01-UNIT","434F-01-UNIT","435F-01-UNIT","436F-01-UNIT","437F-01-UNIT","438F-01-UNIT","439F-01-UNIT","440F-01-UNIT","441F-01-UNIT","457F-01-UNIT","TOTVEHF-01-UNIT","400G-01-UNIT","401G-01-UNIT","402G-01-UNIT","403G-01-UNIT","404G-01-UNIT","405G-01-UNIT","406G-01-UNIT","407G-01-UNIT","408G-01-UNIT","409G-01-UNIT","410G-01-UNIT","411G-01-UNIT","412G-01-UNIT","413G-01-UNIT","414G-01-UNIT","415G-01-UNIT","416G-01-UNIT","417G-01-UNIT","418G-01-UNIT","419G-01-UNIT","420G-01-UNIT","421G-01-UNIT","423G-01-UNIT","424G-01-UNIT","425G-01-UNIT","426G-01-UNIT","427G-01-UNIT","428G-01-UNIT","429G-01-UNIT","430G-01-UNIT","431G-01-UNIT","432G-01-UNIT","433G-01-UNIT","434G-01-UNIT","435G-01-UNIT","436G-01-UNIT","437G-01-UNIT","438G-01-UNIT","439G-01-UNIT","440G-01-UNIT","441G-01-UNIT","457G-01-UNIT","TOTVEHG-01-UNIT","400H-01-UNIT","401H-01-UNIT","402H-01-UNIT","403H-01-UNIT","404H-01-UNIT","405H-01-UNIT","406H-01-UNIT","407H-01-UNIT","408H-01-UNIT","409H-01-UNIT","410H-01-UNIT","411H-01-UNIT","412H-01-UNIT","413H-01-UNIT","414H-01-UNIT","415H-01-UNIT","416H-01-UNIT","417H-01-UNIT","418H-01-UNIT","419H-01-UNIT","420H-01-UNIT","421H-01-UNIT","423H-01-UNIT","424H-01-UNIT","425H-01-UNIT","426H-01-UNIT","427H-01-UNIT","428H-01-UNIT","429H-01-UNIT","430H-01-UNIT","431H-01-UNIT","432H-01-UNIT","433H-01-UNIT","434H-01-UNIT","435H-01-UNIT","436H-01-UNIT","437H-01-UNIT","438H-01-UNIT","439H-01-UNIT","440H-01-UNIT","441H-01-UNIT","457H-01-UNIT","TOTVEHH-01-UNIT","400I-01-UNIT","401I-01-UNIT","402I-01-UNIT","403I-01-UNIT","404I-01-UNIT","405I-01-UNIT","406I-01-UNIT","407I-01-UNIT","408I-01-UNIT","409I-01-UNIT","410I-01-UNIT","411I-01-UNIT","412I-01-UNIT","413I-01-UNIT","414I-01-UNIT","415I-01-UNIT","416I-01-UNIT","417I-01-UNIT","418I-01-UNIT","419I-01-UNIT","420I-01-UNIT","421I-01-UNIT","423I-01-UNIT","424I-01-UNIT","425I-01-UNIT","426I-01-UNIT","427I-01-UNIT","428I-01-UNIT","429I-01-UNIT","430I-01-UNIT","431I-01-UNIT","432I-01-UNIT","433I-01-UNIT","434I-01-UNIT","435I-01-UNIT","436I-01-UNIT","437I-01-UNIT","438I-01-UNIT","439I-01-UNIT","440I-01-UNIT","441I-01-UNIT","457I-01-UNIT","TOTVEHI-01-UNIT","400J-01-UNIT","401J-01-UNIT","402J-01-UNIT","403J-01-UNIT","404J-01-UNIT","405J-01-UNIT","406J-01-UNIT","407J-01-UNIT","408J-01-UNIT","409J-01-UNIT","410J-01-UNIT","411J-01-UNIT","412J-01-UNIT","413J-01-UNIT","414J-01-UNIT","415J-01-UNIT","416J-01-UNIT","417J-01-UNIT","418J-01-UNIT","419J-01-UNIT","420J-01-UNIT","421J-01-UNIT","423J-01-UNIT","424J-01-UNIT","425J-01-UNIT","426J-01-UNIT","427J-01-UNIT","428J-01-UNIT","429J-01-UNIT","430J-01-UNIT","431J-01-UNIT","432J-01-UNIT","433J-01-UNIT","434J-01-UNIT","435J-01-UNIT","436J-01-UNIT","437J-01-UNIT","438J-01-UNIT","439J-01-UNIT","440J-01-UNIT","441J-01-UNIT","457J-01-UNIT","TOTVEHJ-01-UNIT","400F&C-01-SALES","401F&C-01-SALES","402F&C-01-SALES","403F&C-01-SALES","404F&C-01-SALES","405F&C-01-SALES","406F&C-01-SALES","407F&C-01-SALES","408F&C-01-SALES","409F&C-01-SALES","410F&C-01-SALES","411F&C-01-SALES","412F&C-01-SALES","413F&C-01-SALES","414F&C-01-SALES","415F&C-01-SALES","416F&C-01-SALES","417F&C-01-SALES","418F&C-01-SALES","419F&C-01-SALES","420F&C-01-SALES","421F&C-01-SALES","422F&C-01-SALES","423F&C-01-SALES","424F&C-01-SALES","425F&C-01-SALES","426F&C-01-SALES","427F&C-01-SALES","428F&C-01-SALES","429F&C-01-SALES","430F&C-01-SALES","431F&C-01-SALES","432F&C-01-SALES","433F&C-01-SALES","434F&C-01-SALES","435F&C-01-SALES","457F&C-01-SALES","600F&C-01-COS","601F&C-01-COS","602F&C-01-COS","603F&C-01-COS","604F&C-01-COS","605F&C-01-COS","606F&C-01-COS","607F&C-01-COS","608F&C-01-COS","609F&C-01-COS","610F&C-01-COS","611F&C-01-COS","612F&C-01-COS","613F&C-01-COS","614F&C-01-COS","615F&C-01-COS","616F&C-01-COS","617F&C-01-COS","618F&C-01-COS","619F&C-01-COS","620F&C-01-COS","621F&C-01-COS","622F&C-01-COS","623F&C-01-COS","624F&C-01-COS","625F&C-01-COS","626F&C-01-COS","627F&C-01-COS","628F&C-01-COS","629F&C-01-COS","630F&C-01-COS","631F&C-01-COS","632F&C-01-COS","633F&C-01-COS","634F&C-01-COS","635F&C-01-COS","645F&C-01-COS","657F&C-01-COS","NETF&C-01-GRSPFT","637F&C-01-DIRCOST","638F&C-01-DIRCOST","639F&C-01-DIRCOST","640F&C-01-DIRCOST","641F&C-01-DIRCOST","642F&C-01-DIRCOST","400F&C-01-UNIT","401F&C-01-UNIT","402F&C-01-UNIT","403F&C-01-UNIT","404F&C-01-UNIT","405F&C-01-UNIT","406F&C-01-UNIT","407F&C-01-UNIT","408F&C-01-UNIT","409F&C-01-UNIT","410F&C-01-UNIT","411F&C-01-UNIT","412F&C-01-UNIT","413F&C-01-UNIT","414F&C-01-UNIT","415F&C-01-UNIT","416F&C-01-UNIT","417F&C-01-UNIT","418F&C-01-UNIT","419F&C-01-UNIT","420F&C-01-UNIT","421F&C-01-UNIT","422F&C-01-UNIT","423F&C-01-UNIT","424F&C-01-UNIT","425F&C-01-UNIT","426F&C-01-UNIT","427F&C-01-UNIT","428F&C-01-UNIT","429F&C-01-UNIT","430F&C-01-UNIT","431F&C-01-UNIT","432F&C-01-UNIT","433F&C-01-UNIT","434F&C-01-UNIT","435F&C-01-UNIT","457F&C-01-UNIT","VEHF&C-01-UNIT","446A-02-UNIT","446B-02-UNIT","448-02-UNIT","450A-02-UNIT","450B-02-UNIT","452-02-UNIT","USEDVEH-02-UNIT","460A-05-RO","460B-05-RO","460C-05-RO","461A-05-RO","461B-05-RO","461C-05-RO","462-05-RO","463-05-RO","464-05-RO","TOTAL-05-RO","471-06-RO","472-06-RO","473-06-RO","TOTAL-06-RO","806-04-CNTRS","807-04-CNTRS","810-04-CNTRS","443-04-CNTRS","444-04-CNTRS","808-04-CNTRS","809-04-CNTRS","811-04-CNTRS","454-04-CNTRS","455-04-CNTRS","TOTALF&I-04-CNTRS","G&APRO-01-AMT","G&APRO-02-AMT","G&APRO-03-AMT","G&APRO-05-AMT","G&APRO-06-AMT","G&APRO-07-AMT","P&AINCM-05-TRANSFER","P&AINCM-06-TRANSFER","P&AINCM-07-TRANSFER","510DS-03-SALES","710DE-03-EXPNS","CLSDEND-03-UNITBEGN","CLSDEND-03-UNITADD","CLSDEND-03-UNITRMVD","CLSDEND-03-UNITEFF","CLSDEND-03-UNITDISP","CLSDEND-03-UNITRTND","520DS-03-SALES","720DE-03-EXPNS","OPENEND-03-UNITBEGN","OPENEND-03-UNITADD","OPENEND-03-UNITRMVD","OPENEND-03-UNITEFF","OPENEND-03-UNITDISP","OPENEND-03-UNITRTND","530DS-03-SALES","730DE-03-EXPNS","RENTAL-03-UNITBEGN","RENTAL-03-UNITADD","RENTAL-03-UNITRMVD","RENTAL-03-UNITEFF","RENTAL-03-UNITDISP","TOTAL-03-UNITBEGN","TOTAL-03-UNITADD","TOTAL-03-UNITRMVD","TOTAL-03-END&EFFU","TOTAL-03-UNITDISP","TOTAL-03-UNITRTND","277A-AMT","277B-AMT","277C-AMT","277OV30D-AMT","277A-UNIT","277B-UNIT","277C-UNIT","277OV30D-UNIT","277D-COST","277E-COST","277F-COST","277D-ACCDEPR","277E-ACCDEPR","277F-ACCDEPR","277D-UNIT","277E-UNIT","277F-UNIT","220LRB-PREPAID","220LRO-PREPAID","340LRADA-TOTLRECV","220LRNET-TOTLRECV","220LRB-01-30D","220LRO-01-30D","220LRB-31-60D","220LRO-31-60D","220LRB-61-90D","220LRO-61-90D","220LRB-OVER90D","220LRO-OVER90D","541-03-CNTRS","542-03-CNTRS","543-03-CNTRS","544-03-CNTRS","TOTFIPP-03-CNTRS","200-AMT","202-AMT","205-AMT","260-AMT","210VEH-TOTRECV","210OTH-TOTRECV","220VEH-TOTRECV","220L&R-TOTRECV","220SVCPT-TOTRECV","220OTH-TOTRECV","300-DEBTBAL","340-ALLOW","CUSTRECV-NET","261-AMT","262-AMT","263-AMT","264-AMT","230-AMT","231-AMT","237-AMT","235-AMT","238-AMT","240-AMT","241-AMT","242-AMT","243-AMT","244-AMT","245-AMT","246-AMT","247-AMT","252-AMT","258-AMT","270-AMT","271-AMT","274-AMT","275-AMT","277-AMT","347-ACCDEPR","280-COST","281-COST","286-COST","287-COST","288-COST","282-COST","283-COST","284-COST","285-COST","289-COST","351-ACCDEPR","356-ACCDEPR","357-ACCDEPR","358-ACCDEPR","352-ACCDEPR","353-ACCDEPR","354-ACCDEPR","355-ACCDEPR","359-ACCDEPR","FIXASSET-NET","291-AMT","293-AMT","294-AMT","296-AMT","TOTASSET-AMT","202-CB","300TC-AMT","220-CB","220-CD","305-AMT","310-AMT","311-AMT","312-AMT","314-AMT","320-AMT","321-AMT","322-AMT","323-AMT","324-AMT","325-AMT","327-AMT","328-AMT","329-AMT","330-AMT","331-AMT","332-AMT","334-AMT","333-AMT","335-AMT","360-AMT","370-AMT","375-AMT","380-AMT","390-AMT","BSTOBAL-AMT","LIABNETW-AMT","11-01-EXPNS","13-01-EXPNS","15-01-EXPNS","20-01-EXPNS","21-01-EXPNS","22-01-EXPNS","23-01-EXPNS","24-01-EXPNS","26-01-EXPNS","25-01-EXPNS","27-01-EXPNS","29-01-EXPNS","51-01-EXPNS","60-01-EXPNS","61-01-EXPNS","63-01-EXPNS","65-01-EXPNS","64-01-EXPNS","66-01-EXPNS","68-01-EXPNS","69-01-EXPNS","70-01-EXPNS","71-01-EXPNS","72-01-EXPNS","74-01-EXPNS","75-01-EXPNS","76-01-EXPNS","78-01-EXPNS","79-01-EXPNS","56-01-EXPNS","57-01-EXPNS","33-01-EXPNS","77-01-EXPNS","80-01-EXPNS","81-01-EXPNS","82-01-EXPNS","83-01-EXPNS","84-01-EXPNS","85-01-EXPNS","86-01-EXPNS","87-01-EXPNS","88-01-EXPNS","89-01-EXPNS","90-01-EXPNS","91-01-EXPNS","92-01-EXPNS","P&LDEPT-01-AFTERPRO","97-EXPNS","98-EXPNS","99-EXPNS","11-02-EXPNS","13-02-EXPNS","15-02-EXPNS","20-02-EXPNS","21-02-EXPNS","22-02-EXPNS","23-02-EXPNS","24-02-EXPNS","26-02-EXPNS","25-02-EXPNS","27-02-EXPNS","29-02-EXPNS","51-02-EXPNS","60-02-EXPNS","61-02-EXPNS","63-02-EXPNS","65-02-EXPNS","64-02-EXPNS","66-02-EXPNS","68-02-EXPNS","69-02-EXPNS","70-02-EXPNS","71-02-EXPNS","72-02-EXPNS","74-02-EXPNS","75-02-EXPNS","76-02-EXPNS","78-02-EXPNS","79-02-EXPNS","56-02-EXPNS","57-02-EXPNS","33-02-EXPNS","77-02-EXPNS","80-02-EXPNS","81-02-EXPNS","82-02-EXPNS","83-02-EXPNS","84-02-EXPNS","85-02-EXPNS","86-02-EXPNS","87-02-EXPNS","88-02-EXPNS","89-02-EXPNS","90-02-EXPNS","91-02-EXPNS","92-02-EXPNS","P&LDEPT-02-AFTERPRO","11-03-EXPNS","13-03-EXPNS","15-03-EXPNS","20-03-EXPNS","21-03-EXPNS","22-03-EXPNS","23-03-EXPNS","24-03-EXPNS","26-03-EXPNS","25-03-EXPNS","27-03-EXPNS","29-03-EXPNS","51-03-EXPNS","60-03-EXPNS","61-03-EXPNS","63-03-EXPNS","65-03-EXPNS","64-03-EXPNS","66-03-EXPNS","68-03-EXPNS","69-03-EXPNS","70-03-EXPNS","71-03-EXPNS","72-03-EXPNS","74-03-EXPNS","75-03-EXPNS","76-03-EXPNS","78-03-EXPNS","79-03-EXPNS","56-03-EXPNS","57-03-EXPNS","33-03-EXPNS","77-03-EXPNS","80-03-EXPNS","81-03-EXPNS","82-03-EXPNS","83-03-EXPNS","84-03-EXPNS","85-03-EXPNS","86-03-EXPNS","87-03-EXPNS","88-03-EXPNS","89-03-EXPNS","90-03-EXPNS","91-03-EXPNS","92-03-EXPNS","P&LDEPT-03-AFTERPRO","20-05-EXPNS","21-05-EXPNS","22-05-EXPNS","23-05-EXPNS","24-05-EXPNS","26-05-EXPNS","25-05-EXPNS","27-05-EXPNS","29-05-EXPNS","51-05-EXPNS","60-05-EXPNS","61-05-EXPNS","63-05-EXPNS","65-05-EXPNS","64-05-EXPNS","66-05-EXPNS","67-05-EXPNS","68-05-EXPNS","69-05-EXPNS","70-05-EXPNS","71-05-EXPNS","72-05-EXPNS","74-05-EXPNS","75-05-EXPNS","79-05-EXPNS","57-05-EXPNS","33-05-EXPNS","77-05-EXPNS","80-05-EXPNS","81-05-EXPNS","82-05-EXPNS","83-05-EXPNS","84-05-EXPNS","85-05-EXPNS","86-05-EXPNS","87-05-EXPNS","88-05-EXPNS","89-05-EXPNS","90-05-EXPNS","91-05-EXPNS","92-05-EXPNS","P&LDEPT-05-AFTERPRO","20-06-EXPNS","21-06-EXPNS","22-06-EXPNS","23-06-EXPNS","24-06-EXPNS","26-06-EXPNS","25-06-EXPNS","27-06-EXPNS","29-06-EXPNS","51-06-EXPNS","60-06-EXPNS","61-06-EXPNS","63-06-EXPNS","65-06-EXPNS","64-06-EXPNS","66-06-EXPNS","67-06-EXPNS","68-06-EXPNS","69-06-EXPNS","70-06-EXPNS","71-06-EXPNS","72-06-EXPNS","74-06-EXPNS","75-06-EXPNS","79-06-EXPNS","57-06-EXPNS","33-06-EXPNS","77-06-EXPNS","80-06-EXPNS","81-06-EXPNS","82-06-EXPNS","83-06-EXPNS","84-06-EXPNS","85-06-EXPNS","86-06-EXPNS","87-06-EXPNS","88-06-EXPNS","89-06-EXPNS","90-06-EXPNS","91-06-EXPNS","92-06-EXPNS","P&LDEPT-06-AFTERPRO","20-07-EXPNS","21-07-EXPNS","22-07-EXPNS","23-07-EXPNS","24-07-EXPNS","26-07-EXPNS","25-07-EXPNS","27-07-EXPNS","29-07-EXPNS","51-07-EXPNS","60-07-EXPNS","61-07-EXPNS","63-07-EXPNS","65-07-EXPNS","64-07-EXPNS","66-07-EXPNS","67-07-EXPNS","68-07-EXPNS","69-07-EXPNS","70-07-EXPNS","71-07-EXPNS","72-07-EXPNS","74-07-EXPNS","75-07-EXPNS","79-07-EXPNS","57-07-EXPNS","33-07-EXPNS","77-07-EXPNS","80-07-EXPNS","81-07-EXPNS","82-07-EXPNS","83-07-EXPNS","84-07-EXPNS","85-07-EXPNS","86-07-EXPNS","87-07-EXPNS","88-07-EXPNS","89-07-EXPNS","90-07-EXPNS","91-07-EXPNS","92-07-EXPNS","P&LDEPT-07-AFTERPRO","20-09-EXPNS","21-09-EXPNS","22-09-EXPNS","23-09-EXPNS","24-09-EXPNS","26-09-EXPNS","25-09-EXPNS","27-09-EXPNS","29-09-EXPNS","51-09-EXPNS","60-09-EXPNS","61-09-EXPNS","63-09-EXPNS","65-09-EXPNS","64-09-EXPNS","66-09-EXPNS","68-09-EXPNS","69-09-EXPNS","70-09-EXPNS","71-09-EXPNS","72-09-EXPNS","74-09-EXPNS","75-09-EXPNS","79-09-EXPNS","57-09-EXPNS","33-09-EXPNS","77-09-EXPNS","80-09-EXPNS","81-09-EXPNS","82-09-EXPNS","83-09-EXPNS","84-09-EXPNS","85-09-EXPNS","86-09-EXPNS","87-09-EXPNS","88-09-EXPNS","89-09-EXPNS","90-09-EXPNS","91-09-EXPNS","92-09-EXPNS","TOTALEXP-09-EXPNS","902-AMT","903-AMT","905-AMT","AMTTOBAL-AMT","LIFO-ADJ","953-AMT","955-AMT","909-AMT","910-AMT","ADDDED-AMT","400A-01-SALES","401A-01-SALES","402A-01-SALES","403A-01-SALES","404A-01-SALES","405A-01-SALES","406A-01-SALES","407A-01-SALES","408A-01-SALES","409A-01-SALES","410A-01-SALES","411A-01-SALES","412A-01-SALES","413A-01-SALES","414A-01-SALES","415A-01-SALES","416A-01-SALES","417A-01-SALES","418A-01-SALES","420A-01-SALES","421A-01-SALES","423A-01-SALES","424A-01-SALES","425A-01-SALES","426A-01-SALES","427A-01-SALES","428A-01-SALES","429A-01-SALES","430A-01-SALES","431A-01-SALES","432A-01-SALES","433A-01-SALES","434A-01-SALES","435A-01-SALES","436A-01-SALES","437A-01-SALES","438A-01-SALES","440A-01-SALES","441A-01-SALES","457A-01-SALES","600A-01-COS","601A-01-COS","602A-01-COS","603A-01-COS","604A-01-COS","605A-01-COS","606A-01-COS","607A-01-COS","608A-01-COS","609A-01-COS","610A-01-COS","611A-01-COS","612A-01-COS","613A-01-COS","614A-01-COS","615A-01-COS","616A-01-COS","617A-01-COS","618A-01-COS","620A-01-COS","621A-01-COS","623A-01-COS","624A-01-COS","625A-01-COS","626A-01-COS","627A-01-COS","628A-01-COS","629A-01-COS","630A-01-COS","631A-01-COS","632A-01-COS","633A-01-COS","634A-01-COS","635A-01-COS","636A-01-COS","637A-01-COS","638A-01-COS","640A-01-COS","641A-01-COS","657A-01-COS","TOTVEHA-01-GRSPFT","400B-01-SALES","401B-01-SALES","402B-01-SALES","403B-01-SALES","404B-01-SALES","405B-01-SALES","406B-01-SALES","407B-01-SALES","408B-01-SALES","409B-01-SALES","410B-01-SALES","411B-01-SALES","412B-01-SALES","413B-01-SALES","414B-01-SALES","415B-01-SALES","416B-01-SALES","417B-01-SALES","418B-01-SALES","420B-01-SALES","421B-01-SALES","423B-01-SALES","424B-01-SALES","425B-01-SALES","426B-01-SALES","427B-01-SALES","428B-01-SALES","429B-01-SALES","430B-01-SALES","431B-01-SALES","432B-01-SALES","433B-01-SALES","434B-01-SALES","435B-01-SALES","436B-01-SALES","437B-01-SALES","438B-01-SALES","440B-01-SALES","441B-01-SALES","457B-01-SALES","600B-01-COS","601B-01-COS","602B-01-COS","603B-01-COS","604B-01-COS","605B-01-COS","606B-01-COS","607B-01-COS","608B-01-COS","609B-01-COS","610B-01-COS","611B-01-COS","612B-01-COS","613B-01-COS","614B-01-COS","615B-01-COS","616B-01-COS","617B-01-COS","618B-01-COS","620B-01-COS","621B-01-COS","623B-01-COS","624B-01-COS","625B-01-COS","626B-01-COS","627B-01-COS","628B-01-COS","629B-01-COS","630B-01-COS","631B-01-COS","632B-01-COS","633B-01-COS","634B-01-COS","635B-01-COS","636B-01-COS","637B-01-COS","638B-01-COS","640B-01-COS","641B-01-COS","657B-01-COS","TOTVEHB-01-GRSPFT","400C-01-SALES","401C-01-SALES","402C-01-SALES","403C-01-SALES","404C-01-SALES","405C-01-SALES","406C-01-SALES","407C-01-SALES","408C-01-SALES","409C-01-SALES","410C-01-SALES","411C-01-SALES","412C-01-SALES","413C-01-SALES","414C-01-SALES","415C-01-SALES","416C-01-SALES","417C-01-SALES","418C-01-SALES","420C-01-SALES","421C-01-SALES","423C-01-SALES","424C-01-SALES","425C-01-SALES","426C-01-SALES","427C-01-SALES","428C-01-SALES","429C-01-SALES","430C-01-SALES","431C-01-SALES","432C-01-SALES","433C-01-SALES","434C-01-SALES","435C-01-SALES","436C-01-SALES","437C-01-SALES","438C-01-SALES","440C-01-SALES","441C-01-SALES","457C-01-SALES","600C-01-COS","601C-01-COS","602C-01-COS","603C-01-COS","604C-01-COS","605C-01-COS","606C-01-COS","607C-01-COS","608C-01-COS","609C-01-COS","610C-01-COS","611C-01-COS","612C-01-COS","613C-01-COS","614C-01-COS","615C-01-COS","616C-01-COS","617C-01-COS","618C-01-COS","620C-01-COS","621C-01-COS","623C-01-COS","624C-01-COS","625C-01-COS","626C-01-COS","627C-01-COS","628C-01-COS","629C-01-COS","630C-01-COS","631C-01-COS","632C-01-COS","633C-01-COS","634C-01-COS","635C-01-COS","636C-01-COS","637C-01-COS","638C-01-COS","640C-01-COS","641C-01-COS","657C-01-COS","TOTVEHC-01-GRSPFT","400D-01-SALES","401D-01-SALES","402D-01-SALES","403D-01-SALES","404D-01-SALES","405D-01-SALES","406D-01-SALES","407D-01-SALES","408D-01-SALES","409D-01-SALES","410D-01-SALES","411D-01-SALES","412D-01-SALES","413D-01-SALES","414D-01-SALES","415D-01-SALES","416D-01-SALES","417D-01-SALES","418D-01-SALES","420D-01-SALES","421D-01-SALES","423D-01-SALES","424D-01-SALES","425D-01-SALES","426D-01-SALES","427D-01-SALES","428D-01-SALES","429D-01-SALES","430D-01-SALES","431D-01-SALES","432D-01-SALES","433D-01-SALES","434D-01-SALES","435D-01-SALES","436D-01-SALES","437D-01-SALES","438D-01-SALES","440D-01-SALES","441D-01-SALES","457D-01-SALES","600D-01-COS","601D-01-COS","602D-01-COS","603D-01-COS","604D-01-COS","605D-01-COS","606D-01-COS","607D-01-COS","608D-01-COS","609D-01-COS","610D-01-COS","611D-01-COS","612D-01-COS","613D-01-COS","614D-01-COS","615D-01-COS","616D-01-COS","617D-01-COS","618D-01-COS","620D-01-COS","621D-01-COS","623D-01-COS","624D-01-COS","625D-01-COS","626D-01-COS","627D-01-COS","628D-01-COS","629D-01-COS","630D-01-COS","631D-01-COS","632D-01-COS","633D-01-COS","634D-01-COS","635D-01-COS","636D-01-COS","637D-01-COS","638D-01-COS","640D-01-COS","641D-01-COS","657D-01-COS","TOTVEHD-01-GRSPFT","400E-01-SALES","401E-01-SALES","402E-01-SALES","403E-01-SALES","404E-01-SALES","405E-01-SALES","406E-01-SALES","407E-01-SALES","408E-01-SALES","409E-01-SALES","410E-01-SALES","411E-01-SALES","412E-01-SALES","413E-01-SALES","414E-01-SALES","415E-01-SALES","416E-01-SALES","417E-01-SALES","418E-01-SALES","420E-01-SALES","421E-01-SALES","423E-01-SALES","424E-01-SALES","425E-01-SALES","426E-01-SALES","427E-01-SALES","428E-01-SALES","429E-01-SALES","430E-01-SALES","431E-01-SALES","432E-01-SALES","433E-01-SALES","434E-01-SALES","435E-01-SALES","436E-01-SALES","437E-01-SALES","438E-01-SALES","440E-01-SALES","441E-01-SALES","457E-01-SALES","600E-01-COS","601E-01-COS","602E-01-COS","603E-01-COS","604E-01-COS","605E-01-COS","606E-01-COS","607E-01-COS","608E-01-COS","609E-01-COS","610E-01-COS","611E-01-COS","612E-01-COS","613E-01-COS","614E-01-COS","615E-01-COS","616E-01-COS","617E-01-COS","618E-01-COS","620E-01-COS","621E-01-COS","623E-01-COS","624E-01-COS","625E-01-COS","626E-01-COS","627E-01-COS","628E-01-COS","629E-01-COS","630E-01-COS","631E-01-COS","632E-01-COS","633E-01-COS","634E-01-COS","635E-01-COS","636E-01-COS","637E-01-COS","638E-01-COS","640E-01-COS","641E-01-COS","657E-01-COS","TOTVEHE-01-GRSPFT","400F-01-SALES","401F-01-SALES","402F-01-SALES","403F-01-SALES","404F-01-SALES","405F-01-SALES","406F-01-SALES","407F-01-SALES","408F-01-SALES","409F-01-SALES","410F-01-SALES","411F-01-SALES","412F-01-SALES","413F-01-SALES","414F-01-SALES","415F-01-SALES","416F-01-SALES","417F-01-SALES","418F-01-SALES","420F-01-SALES","421F-01-SALES","423F-01-SALES","424F-01-SALES","425F-01-SALES","426F-01-SALES","427F-01-SALES","428F-01-SALES","429F-01-SALES","430F-01-SALES","431F-01-SALES","432F-01-SALES","433F-01-SALES","434F-01-SALES","435F-01-SALES","436F-01-SALES","437F-01-SALES","438F-01-SALES","440F-01-SALES","441F-01-SALES","457F-01-SALES","600F-01-COS","601F-01-COS","602F-01-COS","603F-01-COS","604F-01-COS","605F-01-COS","606F-01-COS","607F-01-COS","608F-01-COS","609F-01-COS","610F-01-COS","611F-01-COS","612F-01-COS","613F-01-COS","614F-01-COS","615F-01-COS","616F-01-COS","617F-01-COS","618F-01-COS","620F-01-COS","621F-01-COS","623F-01-COS","624F-01-COS","625F-01-COS","626F-01-COS","627F-01-COS","628F-01-COS","629F-01-COS","630F-01-COS","631F-01-COS","632F-01-COS","633F-01-COS","634F-01-COS","635F-01-COS","636F-01-COS","637F-01-COS","638F-01-COS","640F-01-COS","641F-01-COS","657F-01-COS","TOTVEHF-01-GRSPFT","400G-01-SALES","401G-01-SALES","402G-01-SALES","403G-01-SALES","404G-01-SALES","405G-01-SALES","406G-01-SALES","407G-01-SALES","408G-01-SALES","409G-01-SALES","410G-01-SALES","411G-01-SALES","412G-01-SALES","413G-01-SALES","414G-01-SALES","415G-01-SALES","416G-01-SALES","417G-01-SALES","418G-01-SALES","420G-01-SALES","421G-01-SALES","423G-01-SALES","424G-01-SALES","425G-01-SALES","426G-01-SALES","427G-01-SALES","428G-01-SALES","429G-01-SALES","430G-01-SALES","431G-01-SALES","432G-01-SALES","433G-01-SALES","434G-01-SALES","435G-01-SALES","436G-01-SALES","437G-01-SALES","438G-01-SALES","440G-01-SALES","441G-01-SALES","457G-01-SALES","600G-01-COS","601G-01-COS","602G-01-COS","603G-01-COS","604G-01-COS","605G-01-COS","606G-01-COS","607G-01-COS","608G-01-COS","609G-01-COS","610G-01-COS","611G-01-COS","612G-01-COS","613G-01-COS","614G-01-COS","615G-01-COS","616G-01-COS","617G-01-COS","618G-01-COS","620G-01-COS","621G-01-COS","623G-01-COS","624G-01-COS","625G-01-COS","626G-01-COS","627G-01-COS","628G-01-COS","629G-01-COS","630G-01-COS","631G-01-COS","632G-01-COS","633G-01-COS","634G-01-COS","635G-01-COS","636G-01-COS","637G-01-COS","638G-01-COS","640G-01-COS","641G-01-COS","657G-01-COS","TOTVEHG-01-GRSPFT","400H-01-SALES","401H-01-SALES","402H-01-SALES","403H-01-SALES","404H-01-SALES","405H-01-SALES","406H-01-SALES","407H-01-SALES","408H-01-SALES","409H-01-SALES","410H-01-SALES","411H-01-SALES","412H-01-SALES","413H-01-SALES","414H-01-SALES","415H-01-SALES","416H-01-SALES","417H-01-SALES","418H-01-SALES","420H-01-SALES","421H-01-SALES","423H-01-SALES","424H-01-SALES","425H-01-SALES","426H-01-SALES","427H-01-SALES","428H-01-SALES","429H-01-SALES","430H-01-SALES","431H-01-SALES","432H-01-SALES","433H-01-SALES","434H-01-SALES","435H-01-SALES","436H-01-SALES","437H-01-SALES","438H-01-SALES","440H-01-SALES","441H-01-SALES","457H-01-SALES","600H-01-COS","601H-01-COS","602H-01-COS","603H-01-COS","604H-01-COS","605H-01-COS","606H-01-COS","607H-01-COS","608H-01-COS","609H-01-COS","610H-01-COS","611H-01-COS","612H-01-COS","613H-01-COS","614H-01-COS","615H-01-COS","616H-01-COS","617H-01-COS","618H-01-COS","620H-01-COS","621H-01-COS","623H-01-COS","624H-01-COS","625H-01-COS","626H-01-COS","627H-01-COS","628H-01-COS","629H-01-COS","630H-01-COS","631H-01-COS","632H-01-COS","633H-01-COS","634H-01-COS","635H-01-COS","636H-01-COS","637H-01-COS","638H-01-COS","640H-01-COS","641H-01-COS","657H-01-COS","TOTVEHH-01-GRSPFT","400I-01-SALES","401I-01-SALES","402I-01-SALES","403I-01-SALES","404I-01-SALES","405I-01-SALES","406I-01-SALES","407I-01-SALES","408I-01-SALES","409I-01-SALES","410I-01-SALES","411I-01-SALES","412I-01-SALES","413I-01-SALES","414I-01-SALES","415I-01-SALES","416I-01-SALES","417I-01-SALES","418I-01-SALES","420I-01-SALES","421I-01-SALES","423I-01-SALES","424I-01-SALES","425I-01-SALES","426I-01-SALES","427I-01-SALES","428I-01-SALES","429I-01-SALES","430I-01-SALES","431I-01-SALES","432I-01-SALES","433I-01-SALES","434I-01-SALES","435I-01-SALES","436I-01-SALES","437I-01-SALES","438I-01-SALES","440I-01-SALES","441I-01-SALES","457I-01-SALES","600I-01-COS","601I-01-COS","602I-01-COS","603I-01-COS","604I-01-COS","605I-01-COS","606I-01-COS","607I-01-COS","608I-01-COS","609I-01-COS","610I-01-COS","611I-01-COS","612I-01-COS","613I-01-COS","614I-01-COS","615I-01-COS","616I-01-COS","617I-01-COS","618I-01-COS","620I-01-COS","621I-01-COS","623I-01-COS","624I-01-COS","625I-01-COS","626I-01-COS","627I-01-COS","628I-01-COS","629I-01-COS","630I-01-COS","631I-01-COS","632I-01-COS","633I-01-COS","634I-01-COS","635I-01-COS","636I-01-COS","637I-01-COS","638I-01-COS","640I-01-COS","641I-01-COS","657I-01-COS","TOTVEHI-01-GRSPFT","400J-01-SALES","401J-01-SALES","402J-01-SALES","403J-01-SALES","404J-01-SALES","405J-01-SALES","406J-01-SALES","407J-01-SALES","408J-01-SALES","409J-01-SALES","410J-01-SALES","411J-01-SALES","412J-01-SALES","413J-01-SALES","414J-01-SALES","415J-01-SALES","416J-01-SALES","417J-01-SALES","418J-01-SALES","420J-01-SALES","421J-01-SALES","423J-01-SALES","424J-01-SALES","425J-01-SALES","426J-01-SALES","427J-01-SALES","428J-01-SALES","429J-01-SALES","430J-01-SALES","431J-01-SALES","432J-01-SALES","433J-01-SALES","434J-01-SALES","435J-01-SALES","436J-01-SALES","437J-01-SALES","438J-01-SALES","440J-01-SALES","441J-01-SALES","445J-01-SALES","457J-01-SALES","600J-01-COS","601J-01-COS","602J-01-COS","603J-01-COS","604J-01-COS","605J-01-COS","606J-01-COS","607J-01-COS","608J-01-COS","609J-01-COS","610J-01-COS","611J-01-COS","612J-01-COS","613J-01-COS","614J-01-COS","615J-01-COS","616J-01-COS","617J-01-COS","618J-01-COS","620J-01-COS","621J-01-COS","623J-01-COS","624J-01-COS","625J-01-COS","626J-01-COS","627J-01-COS","628J-01-COS","629J-01-COS","630J-01-COS","631J-01-COS","632J-01-COS","633J-01-COS","634J-01-COS","635J-01-COS","636J-01-COS","637J-01-COS","638J-01-COS","640J-01-COS","641J-01-COS","645J-01-COS","657J-01-COS","TOTVEHJ-01-GRSPFT","446A-02-SALES","446B-02-SALES","448-02-SALES","450A-02-SALES","450B-02-SALES","452-02-SALES","456-02-SALES","646A-02-COS","646B-02-COS","647A-02-COS","647B-02-COS","648-02-COS","649-02-COS","650A-02-COS","650B-02-COS","651A-02-COS","651B-02-COS","652-02-COS","653-02-COS","656-02-COS","USEDVEH-02-GRSPFT","460A-05-SALES","460B-05-SALES","460C-05-SALES","461A-05-SALES","461B-05-SALES","461C-05-SALES","462-05-SALES","463-05-SALES","464-05-SALES","469-05-SALES","466-05-SALES","470-06-SALES","471-06-SALES","472-06-SALES","473-06-SALES","476-06-SALES","479-06-SALES","BODYTOTL-06-GRSPFT","480-07-SALES","467-07-SALES","468-07-SALES","478-07-SALES","477-07-SALES","481-07-SALES","482-07-SALES","483-07-SALES","484-07-SALES","490-07-SALES","491-07-SALES","492-07-SALES","660A-05-COS","660B-05-COS","660C-05-COS","661A-05-COS","661B-05-COS","661C-05-COS","662-05-COS","663-05-COS","664-05-COS","665-05-COS","669-05-COS","666-05-COS","MECHTOTL-05-GRSPFT","670-06-COS","671-06-COS","672-06-COS","673-06-COS","675-06-COS","676-06-COS","679-06-COS","680-07-COS","667-07-COS","668-07-COS","678-07-COS","677-07-COS","681-07-COS","682-07-COS","683-07-COS","684-07-COS","687-07-COS","688-07-COS","690-07-COS","691-07-COS","692-07-COS","P&ADEPT-07-GRSPFT","810-04-SALES","443-04-SALES","444-04-SALES","811-04-SALES","454-04-SALES","455-04-SALES","806-04-SALES","807-04-SALES","850-04-COS","860-04-COS","643-04-COS","644-04-COS","853-04-COS","855-04-COS","808-04-SALES","809-04-SALES","851-04-COS","861-04-COS","654-04-COS","655-04-COS","854-04-COS","856-04-COS","TOTALF&I-04-GRSINC","511CLSD-03-GRSINC","512CLSD-03-GRSINC","513CLSD-03-GRSINC","514CLSD-03-GRSINC","516CLSD-03-GRSINC","517CLSD-03-GRSINC","711CLSD-03-COS","712CLSD-03-COS","713CLSD-03-COS","714CLSD-03-COS","715CLSD-03-COS","716CLSD-03-COS","717CLSD-03-COS","718CLSD-03-COS","510GL-03-AMT","521OPEN-03-GRSINC","522OPEN-03-GRSINC","523OPEN-03-GRSINC","524OPEN-03-GRSINC","526OPEN-03-GRSINC","527OPEN-03-GRSINC","721OPEN-03-COS","722OPEN-03-COS","723OPEN-03-COS","724OPEN-03-COS","725OPEN-03-COS","726OPEN-03-COS","727OPEN-03-COS","728OPEN-03-COS","520GL-03-AMT","534RENT-03-GRSINC","535RENT-03-GRSINC","536RENT-03-GRSINC","731RENT-03-COS","732RENT-03-COS","733RENT-03-COS","734RENT-03-COS","735RENT-03-COS","736RENT-03-COS","737RENT-03-COS","738RENT-03-COS","530GL-03-AMT","GPINTOTL-03-GRSPFT","542-03-SALES","543-03-SALES","544-03-SALES","742-03-COS","743-03-COS","744-03-COS","541-03-SALES","741-03-COS","740-03-COS","FIPPTOTL-03-GRSINC","336-AMT","337-AMT","338-AMT","494P5A-01-CNTRS","494P5B-01-CNTRS","494P5C-01-CNTRS","494P5D-01-CNTRS","494P5E-01-CNTRS","494P5F-01-CNTRS","494P5G-01-CNTRS","494P5H-01-CNTRS","494P5I-01-CNTRS","494P5J-01-CNTRS","494P5A-01-SALES","494P5B-01-SALES","494P5C-01-SALES","494P5D-01-SALES","494P5E-01-SALES","494P5F-01-SALES","494P5G-01-SALES","494P5H-01-SALES","494P5I-01-SALES","494P5J-01-SALES","494P5A-01-GRSINC","494P5B-01-GRSINC","494P5C-01-GRSINC","494P5D-01-GRSINC","494P5E-01-GRSINC","494P5F-01-GRSINC","494P5G-01-GRSINC","494P5H-01-GRSINC","494P5I-01-GRSINC","494P5J-01-GRSINC","494-04-CNTRS","494-04-SALES","494-04-GRSINC","494-04-COS","494P5A-01-COS","494P5B-01-COS","494P5C-01-COS","494P5D-01-COS","494P5E-01-COS","494P5F-01-COS","494P5G-01-COS","494P5H-01-COS","494P5I-01-COS","494P5J-01-COS","495-04-CNTRS","495-04-SALES","495-04-GRSINC","495-04-COS","695-04-COS","694P5A-01-COS","694P5B-01-COS","694P5C-01-COS","694P5D-01-COS","694P5E-01-COS","694P5F-01-COS","694P5G-01-COS","694P5H-01-COS","694P5I-01-COS","694P5J-01-COS");
//    }

	@Override
	public List<AccountingOemFsCellCode> getOemTMappingList(String oemId, Integer year, Integer version, String countryCode) {
		log.info("Fetching AccountingOemFsCellCode from DB.");
		return fsCellCodeRepo.getFsCellCodesForOemYearAndCountry(oemId, year, version, countryCode);
	}

	@Override
	public List<AccountingOemFsCellCode> getOemTMappingList(String oemId, Integer year, Integer version, String countryCode, boolean readFromCache){
		if(StringUtils.isEmpty(countryCode)){
			countryCode = dealerConfig.getDealerCountryCode();
		}
		if(readFromCache){
			log.info("callToRead cell codes from cache!");
			return getOemTMappingListFromCache(oemId, year, version, countryCode);
		}
		return getOemTMappingList(oemId, year, version, countryCode);
	}


	@Override
	public List<OemFsMapping> updateOemFsMapping(OemFsMappingUpdateDto requestDto) {
		List<String> glAccountIds = requestDto.getMappingsToSave().stream()
				.map(OemFsMappingDetail::getGlAccountId)
				.collect(Collectors.toList());
		glAccountIds.addAll(requestDto.getMappingsToDelete().stream()
				.map(OemFsMappingDetail::getGlAccountId)
				.collect(Collectors.toList()));

		List<OemFsMapping> existingOemFsMappings = oemFsMappingRepo.findByGlAccountIdAndYearIncludeDeleted(requestDto.getFsId(), glAccountIds, getCurrentDealerId());

		Map<String, List<OemFsMapping>> glAcctIdVsListOfGroupsInDbMap = Maps.newHashMap();

		existingOemFsMappings.forEach(m -> {
			glAcctIdVsListOfGroupsInDbMap.computeIfAbsent( m.getGlAccountId(), k -> Lists.newArrayList()).add(m);
		});

		List<OemFsMapping> mappingsToUpsertInDb = Lists.newArrayList();

		populateMappings(requestDto, glAcctIdVsListOfGroupsInDbMap, mappingsToUpsertInDb);

		oemFsMappingRepo.updateBulk(mappingsToUpsertInDb);

		return getOemFsMapping(requestDto.getFsId());
	}

	private List<AccountingOemFsCellCode> getOemTMappingListFromCache(String oemId, Integer year, Integer version, String countryCode) {
		CellCodeKey cellCodeKey = CellCodeKey.builder().oemId(oemId).year(year).version(version).countryCode(countryCode).build();
		try {
			return accountingOemFsCellCodesCache.get(cellCodeKey);
		} catch (ExecutionException e) {
			log.error("Error while fetching cell codes from cache ",e);
			return getOemTMappingList(oemId,year,version, countryCode);
		}
	}

	private void populateMappings(OemFsMappingUpdateDto requestDto, Map<String, List<OemFsMapping>> glAcctIdVsListOfCodesInDbMap, List<OemFsMapping> mappingsToUpsertInDb) {

		FSEntry fsEntry = fsEntryRepo.findByIdAndDealerIdWithNullCheck(requestDto.getFsId(),getCurrentDealerId());
		TCollectionUtils.nullSafeList(requestDto.getMappingsToDelete()).forEach( mappingDetailReq -> {
			List<OemFsMapping> oemFsMappingsFromDb = glAcctIdVsListOfCodesInDbMap.get(mappingDetailReq.getGlAccountId());
			Map<String, OemFsMapping> groupCodeVsOemFsMappingFromDbMap = TCollectionUtils.transformToMap(oemFsMappingsFromDb, OemFsMapping::getFsCellGroupCode);
			OemFsMapping oemFsMappingFromDb = groupCodeVsOemFsMappingFromDbMap.get(mappingDetailReq.getFsCellGroupCode());
			if(Objects.nonNull(oemFsMappingFromDb)){
				oemFsMappingFromDb.setDeleted(true);
				oemFsMappingFromDb.setModifiedTime(System.currentTimeMillis());
				oemFsMappingFromDb.setModifiedByUserId(UserContextProvider.getCurrentUserId());
				mappingsToUpsertInDb.add(oemFsMappingFromDb);
			}
		});

		TCollectionUtils.nullSafeList(requestDto.getMappingsToSave()).forEach( mappingDetailReq -> {
			String glAccountId = mappingDetailReq.getGlAccountId();
			String groupCode = mappingDetailReq.getFsCellGroupCode();
			String glAccountDealerId = mappingDetailReq.getGlAccountDealerId();
			if(FSType.CONSOLIDATED.name().equals(fsEntry.getFsType()) && StringUtils.isEmpty(glAccountDealerId)){
				throw new TBaseRuntimeException("glAccountDealerId cannot be empty for Consolidated FS mappings");
			}
			List<OemFsMapping> oemFsMappingsFromDb = TCollectionUtils.nullSafeList(glAcctIdVsListOfCodesInDbMap.get(glAccountId));
			Map<String, OemFsMapping> groupCodeVsOemFsMappingFromDbMap = TCollectionUtils.transformToMap(oemFsMappingsFromDb, OemFsMapping::getFsCellGroupCode);

			if(!groupCodeVsOemFsMappingFromDbMap.containsKey(groupCode)){
				OemFsMapping oemFsMapping =  OemFsMapping.builder()
						.oemId(fsEntry.getOemId())
						.fsId(fsEntry.getId())
						.fsCellGroupCode(groupCode)
						.glAccountId(glAccountId)
						.dealerId(getCurrentDealerId())
						.glAccountDealerId(glAccountDealerId)
						.year(fsEntry.getYear())
						.version(fsEntry.getVersion())
						.siteId(requestDto.getSiteId())
						.modifiedByUserId(UserContextProvider.getCurrentUserId())
						.createdByUserId(UserContextProvider.getCurrentUserId())
						.build();
				oemFsMapping.setCreatedTime(System.currentTimeMillis());
				oemFsMapping.setModifiedTime(System.currentTimeMillis());
				mappingsToUpsertInDb.add(oemFsMapping);
			}else{
				if(groupCodeVsOemFsMappingFromDbMap.get(groupCode).isDeleted()){
					groupCodeVsOemFsMappingFromDbMap.get(groupCode).setDeleted(false);
					groupCodeVsOemFsMappingFromDbMap.get(groupCode).setModifiedTime(System.currentTimeMillis());
					groupCodeVsOemFsMappingFromDbMap.get(groupCode).setModifiedByUserId(UserContextProvider.getCurrentUserId());
					mappingsToUpsertInDb.add(groupCodeVsOemFsMappingFromDbMap.get(groupCode));
				}
			}
		});
	}


	@Override
	public List<OemFsMapping> getOemFsMapping(String fsId) {
		return TCollectionUtils.nullSafeList(
				oemFsMappingRepo.findMappingsByFsId(fsId, getCurrentDealerId()));
	}

	@Override
	public FsCellCodeDetailsResponseDto computeFsCellCodeDetails(String oemId, Integer oemFsYear, Integer version, Integer year, Integer month, boolean includeM13, String siteId, boolean addM13BalInDecBalances) {
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, oemFsYear ,UserContextProvider.getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		MonthInfo activeMonthInfo = getActiveMonthInfo();

		if(Objects.nonNull(year) && Objects.nonNull(month) && isFutureMonth(activeMonthInfo, year, month - 1)){
			return FsCellCodeDetailsResponseDto.builder().build();
		}
		Map<String, TrialBalanceRow> trialBalanceRowMap = getTrialBalanceRowForGlAccounts(activeMonthInfo, year, month, includeM13, addM13BalInDecBalances);

		FsReportContext context = FsReportContext.builder()
				.fsId(fsEntry.getId())
				.fromMonth(Calendar.JANUARY + 1)
				.fromYear(year)
				.oemFsYear(oemFsYear)
				.oemId(oemId)
				.requestedMonth(month)
				.requestedYear(year)
				.siteId(siteId)
				.trialBalanceRowMap(trialBalanceRowMap)
				.version(version)
				.fsByFiscalYear(false)
				.fsTime(TimeUtils.getMonthsEndTime(year, month))
				.build();

		return getFsCellCodeDetailsReport(context);
	}

	@Override
	public FsCellCodeDetailsResponseDto computeFsCellCodeDetailsByFsId(String fsId, long tillEpoch, boolean includeM13, boolean addM13BalInDecBalances){
		FSEntry fsEntry =fsEntryRepo.findByIdAndDealerIdWithNullCheck(fsId, UserContextProvider.getCurrentDealerId());
		return computeFsCellCodeDetails(fsEntry, tillEpoch, includeM13, addM13BalInDecBalances);
	}

	@Override
	public FsCellCodeDetailsResponseDto computeFsCellCodeDetails(FSEntry fsEntry, long tillEpoch, boolean includeM13, boolean addM13BalInDecBalances) {
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		Calendar c = TimeUtils.buildCalendar(tillEpoch);
		if(isFutureMonth(activeMonthInfo, c.get(Calendar.YEAR), c.get(Calendar.MONTH) )){
			return FsCellCodeDetailsResponseDto.builder().build();
		}
		log.info("includeM13: {}", includeM13);
		AccountingInfo accountingInfo = aiService.find(UserContextProvider.getCurrentDealerId());
		OemConfig oemConfig = getOemConfig(fsEntry.getOemId());

		FsReportContext context = FsReportContext.builder()
				.fsId(fsEntry.getId())
				.fromMonth(Calendar.JANUARY+1)
				.fromYear(c.get(Calendar.YEAR))
				.oemFsYear(fsEntry.getYear())
				.oemId(fsEntry.getOemId())
				.requestedMonth(c.get(Calendar.MONTH) + 1)
				.requestedYear(c.get(Calendar.YEAR))
				.siteId(fsEntry.getSiteId())
				.version(fsEntry.getVersion())
				.fsByFiscalYear(false)
				.fsTime(tillEpoch)
				.oemConfig(oemConfig)
				.accountingInfo(accountingInfo)
				.tillEpoch(tillEpoch)
				.includeM13(includeM13)
				.addM13BalInDecBalances(addM13BalInDecBalances)
				.build();

		fetchTrialBalanceRowForGlAccounts(context, fsEntry);

		if(isRoundOffAndOffset(oemConfig, accountingInfo)){
			return getFsDetailsReportWithRoundOff(context);
		}

		return getFsCellCodeDetailsReport(context);
	}

	@Override
	public FsGroupCodeDetailsResponseDto computeFsGroupCodeDetails(String oemId, Integer oemFsYear, Integer oemFsVersion, long tillEpoch, boolean includeM13, boolean addM13BalInDecBalances, String siteId) {
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, oemFsYear ,UserContextProvider.getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		FsGroupCodeDetailsResponseDto responseDto = new FsGroupCodeDetailsResponseDto();
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		Calendar c = TimeUtils.buildCalendar(tillEpoch);
		if(isFutureMonth(activeMonthInfo, c.get(Calendar.YEAR), c.get(Calendar.MONTH) )){
			return FsGroupCodeDetailsResponseDto.builder().build();
		}
		log.info("includeM13: {}", includeM13);
		Map<String, TrialBalanceRow> trialBalanceRowMap = getGlAccountIdToTrialBMap(accountingService.getCYTrialBalanceTillDayOfMonth(tillEpoch,Sets.newConcurrentHashSet(),
				false,
				includeM13,
				DpUtils.doUseTbGeneratorV2VersionForFsInOem(), addM13BalInDecBalances));

		FsReportContext context = FsReportContext.builder()
				.fsId(fsEntry.getId())
				.fromMonth(Calendar.JANUARY+1)
				.fromYear(c.get(Calendar.YEAR))
				.oemFsYear(oemFsYear)
				.oemId(oemId)
				.requestedMonth(c.get(Calendar.MONTH) + 1)
				.requestedYear(c.get(Calendar.YEAR))
				.trialBalanceRowMap(trialBalanceRowMap)
				.version(oemFsVersion)
				.fsByFiscalYear(false)
				.siteId(siteId)
				.build();

		Map<String, GLAccount> idGlAccountMap = TCollectionUtils.transformToMap(accountingService.getGLAccounts(UserContextProvider.getCurrentDealerId()),GLAccount::getId);
		Map<String, FsGroupCodeDetail> groupCodeDisplayNameVsDetailsMap = Maps.newHashMap();
		Map<String, List<String>> groupCodeVsGlAccountsMap = getGlAccountsForFsCellGroups(context);
		Map<String,String> oemFsGroupCodeVsDisplayNameMap = TCollectionUtils.nullSafeList(oemFsCellGroupRepo.findNonDeletedByOemIdYearVersionAndCountry(oemId, oemFsYear, oemFsVersion, dealerConfig.getDealerCountryCode()))
				.stream().collect(Collectors.toMap(AccountingOemFsCellGroup::getGroupCode, AccountingOemFsCellGroup::getGroupDisplayName));
		for(Map.Entry<String,List<String>> entry : groupCodeVsGlAccountsMap.entrySet()){
			if(!oemFsGroupCodeVsDisplayNameMap.containsKey(entry.getKey())){
				log.warn("invalid mapping exists with deleted group code : {}",entry.getKey());
				continue;
			}
			BigDecimal mtdBalance = BigDecimal.ZERO;
			BigDecimal ytdBalance = BigDecimal.ZERO;
			long mtdCount = 0;
			long ytdCount = 0;
			List<String> dependentGlAccounts = new ArrayList<>();
			List<String> glAccounts = TCollectionUtils.nullSafeList(entry.getValue());
			for(String glAccountId : glAccounts){
				String glAccountNumber = glAccountId;
				GLAccount glAccount = idGlAccountMap.get(glAccountId);
				if(Objects.nonNull(glAccount) && !glAccount.getAccountNumber().equals(TConstants.BLANK_STRING)){
					glAccountNumber = glAccount.getAccountNumber();
				}
				if(trialBalanceRowMap.containsKey(glAccountId)){
					TrialBalanceRow data = trialBalanceRowMap.get(glAccountId);
					mtdBalance = mtdBalance.add(getMtdBalance(data));
					ytdBalance = ytdBalance.add(getYtdBalance(data));
					mtdCount = mtdCount + data.getCount();
					ytdCount = ytdCount + data.getYtdCount();
					dependentGlAccounts.add(glAccountNumber);
				}
			}
			FsGroupCodeDetail groupCodeDetail = FsGroupCodeDetail.builder().mtdBalance(mtdBalance)
					.ytdBalance(ytdBalance)
					.mtdCount(mtdCount)
					.ytdCount(ytdCount)
					.dependentGlAccounts(dependentGlAccounts)
					.build();
			String groupCodeDisplayName = oemFsGroupCodeVsDisplayNameMap.get(entry.getKey());
			groupCodeDisplayNameVsDetailsMap.put(groupCodeDisplayName, groupCodeDetail);
		}
		responseDto.setDetails(groupCodeDisplayNameVsDetailsMap);
		responseDto.setDate(TimeUtils.getStringFromEpoch(tillEpoch,"dd-MM-yyyy"));
		return responseDto;
	}

	@Override
	public FsCellCodeDetailsResponseDto computeFsDetails(String oemId, Integer oemFsYear, Integer oemFsVersion, long tillEpoch, boolean includeM13, boolean addM13BalInDecBalances){
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, oemFsYear ,UserContextProvider.getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		Calendar c = TimeUtils.buildCalendar(tillEpoch);
		if(isFutureMonth(activeMonthInfo, c.get(Calendar.YEAR), c.get(Calendar.MONTH) )){
			return FsCellCodeDetailsResponseDto.builder().build();
		}
		Map<String, TrialBalanceRow> trialBalanceRowMap = getGlAccountIdToTrialBMap(accountingService.getCYTrialBalanceTillDayOfMonth(tillEpoch,
				Sets.newConcurrentHashSet(),
				false,
				includeM13,
				DpUtils.doUseTbGeneratorV2VersionForFsInOem(), addM13BalInDecBalances));

		FsReportContext context = FsReportContext.builder()
				.fsId(fsEntry.getId())
				.fromMonth(Calendar.JANUARY+1)
				.fromYear(c.get(Calendar.YEAR))
				.oemFsYear(oemFsYear)
				.oemId(oemId)
				.requestedMonth(c.get(Calendar.MONTH) + 1)
				.requestedYear(c.get(Calendar.YEAR))
				.trialBalanceRowMap(trialBalanceRowMap)
				.version(oemFsVersion)
				.fsByFiscalYear(false)
				.build();

		return getFsDetailsReportWithRoundOff(context);
	}

	@Override
	public FsCellCodeDetailsResponseDto computeFsCellCodeDetailsForFS(String fsId, long tillEpoch, boolean includeM13) {

		FSEntry fsEntry = fsEntryRepo.findByIdAndDealerIdWithNullCheck(fsId, UserContextProvider.getCurrentDealerId());

		MonthInfo activeMonthInfo = getActiveMonthInfo();
		Calendar c = TimeUtils.buildCalendar(tillEpoch);


		if(isFutureMonth(activeMonthInfo, c.get(Calendar.YEAR), c.get(Calendar.MONTH) )){
			return FsCellCodeDetailsResponseDto.builder().build();
		}

		int fiscalStartMonth = getFiscalYearStartMonth();

		Map<String, TrialBalanceRow> trialBalanceRowMap =
				getCumulativeTrialBalance(fiscalStartMonth, c);

		YearMonth yearMonth = getFYStartDetails(c.get(Calendar.YEAR), c.get(Calendar.MONTH), fiscalStartMonth);

		FsReportContext context = FsReportContext.builder()
				.fsId(fsId)
				.fromYear(yearMonth.getYear())
				.fromMonth(yearMonth.getMonthValue())
				.oemFsYear(fsEntry.getYear())
				.oemId(fsEntry.getOemId())
				.requestedMonth(c.get(Calendar.MONTH) + 1)
				.requestedYear( c.get(Calendar.YEAR))
				.siteId(fsEntry.getSiteId())
				.trialBalanceRowMap(trialBalanceRowMap)
				.version(fsEntry.getVersion())
				.fsByFiscalYear(true)
				.fsTime(tillEpoch)
				.build();

		return getFsCellCodeDetailsReport(context);
	}

	@Override
	public FSEntry createFsmInfoIfPresent(OEM oem, int year, int version){
		FSEntry previousInfo = fsEntryRepo.findByOem(oem.name(), version, UserContextProvider.getCurrentDealerId());
		if(Objects.isNull(previousInfo)){
			log.info("not creating oemMappingInfo for {} {}", oem.name(), year);
			return null;
		}
		return fsEntryService.createFSEntry(FsEntryCreateDto.builder().oemId(oem).year(year).version(version).build());
	}

	@Override
	public List<OemFsMapping> deleteFSMappings(OEM oem, int year, int version, Set<String> groupCodes){
		if(TCollectionUtils.isEmpty(groupCodes)) return Lists.newArrayList();
		FSMappingDeleteDto dto = FSMappingDeleteDto.builder().oemId(oem).year(year)
				.groupDisplayNames(groupCodes).version(version).build();
		List<OemFsMapping> deletedMappings  = deleteFSMappings(dto);
		log.info("{} mappings deleted for {} {}, dealerId {} siteId {}",
				deletedMappings.size(), oem.name(), year, UserContextProvider.getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		return Lists.newArrayList();
	}


	private Map<String, TrialBalanceRow> getCumulativeTrialBalance(int fiscalStartMonth, Calendar tillDate) {

		int requestedMoth = tillDate.get(Calendar.MONTH);
		int fiscalStartYear = tillDate.get(Calendar.YEAR);

		if(requestedMoth < fiscalStartMonth){
			fiscalStartYear = fiscalStartYear-1;
		}

		TrialBalance trialBalance = accountingService.getFSTrialBalanceTillDayOfMonth(fiscalStartYear,
						fiscalStartMonth,tillDate.get(Calendar.YEAR), tillDate.get(Calendar.MONTH)
						, tillDate.getTimeInMillis());

		return trialBalance.getAccountRows().stream().collect(Collectors.toMap(TrialBalanceRow::getAccountId, k -> k));
	}

	@Override
	public List<OEMFsCellCodeSnapshotResponseDto> getFsCellCodeDetails(String oemId, Integer oemFsYear, Integer oemFsVersion,
																	   long tillEpoch, Set<String> codes, boolean includeM13, boolean addM13BalInDecBalances) {
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId,oemFsYear, UserContextProvider.getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		List<OEMFsCellCodeSnapshotResponseDto> oemFsCellCodeSnapshotResponseDtoList = Lists.newArrayList();
		FsCellCodeDetailsResponseDto fsCellCodeDetailsResponseDto = computeFsCellCodeDetails(fsEntry, tillEpoch, includeM13, addM13BalInDecBalances);
		Map<String, FsCodeDetail> codeVsDetailsMap = fsCellCodeDetailsResponseDto.getCodeVsDetailsMap();
		codeVsDetailsMap.keySet().forEach(key -> {
			if(codes.contains(key)) {
				OEMFsCellCodeSnapshotResponseDto dto = new OEMFsCellCodeSnapshotResponseDto(
						key, codeVsDetailsMap.get(key).getValue());
				oemFsCellCodeSnapshotResponseDtoList.add(dto);
			}
		});

		return oemFsCellCodeSnapshotResponseDtoList;
	}

	// Uses month indexing from {1,......, 12}
	private FsCellCodeDetailsResponseDto getFsCellCodeDetailsReport(FsReportContext fsrContext) {

		//log.info("IN getFsCellCodeDetailsReport time {}, FsReportContext {}", System.currentTimeMillis(), fsrContext);

		List<AccountingOemFsCellCode> fsCellCodes =
				getOemTMappingListFromCache(fsrContext.getOemId(), fsrContext.getOemFsYear(), fsrContext.getVersion(), dealerConfig.getDealerCountryCode());

		Map<String, AccountingOemFsCellCode> codeVsCellInfoMap = TCollectionUtils.transformToMap(fsCellCodes, AccountingOemFsCellCode::getCode);

		List<AccountingOemFsCellCode> derivedFSCellCode = Lists.newArrayList();
		List<AccountingOemFsCellCode> nonDerivedFSCellCode = Lists.newArrayList();
		List<AccountingOemFsCellCode> monthlyFSCellCodes = Lists.newArrayList();
		Map<String, List<String>> groupCodeVsGlAccountsMap = getGlAccountsForFsCellGroups(fsrContext);
		Map<String, MemoWorksheet> memoKeyToWorksheetMap = getMemoWorksheetMap(fsrContext);
		Map<String, HCWorksheet> hcKeyToWorksheetmap = getHCWorksheetMap(fsrContext);
		OemConfig oemConfig = getOemConfig(fsrContext.getOemId());
		Set<String> monthlyCellCodes = new HashSet<>();

		OemFsCellContext oemFsCellContext = OemFsCellContext.builder()
				.requestedYear(fsrContext.getRequestedYear())
				.requestedMonth(fsrContext.getRequestedMonth())
				.codeVsCellInfoMap(codeVsCellInfoMap)
				.groupCodeVsGlAccountsMap(groupCodeVsGlAccountsMap)
				.trialBalanceRowMap(fsrContext.getTrialBalanceRowMap())
				.memoKeyToValueMap(memoKeyToWorksheetMap)
				.hcKeyValueMap(hcKeyToWorksheetmap)
				.roundOff(getRoundOffProperty(oemConfig))
				.defaultPrecision(getDefaultPrecision(fsrContext.getOemId(), oemConfig))
				.monthlyCodes(monthlyCellCodes)
				.oemConfig(oemConfigRepo.findByOemId(fsrContext.getOemId(), dealerConfig.getDealerCountryCode()))
				.accountingInfo(aiService.find(UserContextProvider.getCurrentDealerId()))
				.fsTime(fsrContext.getFsTime())
				.build();


		fsCellCodes.forEach(c -> {
			if(c.isDerived()){
				derivedFSCellCode.add(c);
				oemFsCellContext.getCodeVsExpressionMap().put(c.getCode(), "(" + c.getExpression() + ")");
				if(OemCellSubType.MONTHLY.name().equalsIgnoreCase(c.getSubType())){
					if(Integer.parseInt(c.getAdditionalInfo().get(additionInfoField_month)) != oemFsCellContext.getRequestedMonth()){
						monthlyCellCodes.add(c.getCode());
						monthlyFSCellCodes.add(c);
					}
				}
			}else{
				nonDerivedFSCellCode.add(c);
			}
		});

		// Start : non-derived codes
		computeNonDerivedCellCodes(oemFsCellContext, nonDerivedFSCellCode, groupCodeVsGlAccountsMap);
		// End : non-derived codes
		// Start : monthly code's values

		if(FinancialStatementUtils.useSnapshotValuesInFS(oemFsCellContext)){
			fetchSnapshotValues(fsrContext, oemFsCellContext);
		}

		monthlyFSCellCodes.forEach(c ->{
			if(Integer.parseInt(c.getAdditionalInfo().get(additionInfoField_month)) == fsrContext.getFromMonth()){
				oemFsCellContext.setFsCellCode(c);
				computeMonthlyExpressions(oemFsCellContext);
			}
		});
		Set<String> codesRelatedToMonthlyPL = new HashSet<>();
		Set<String> glIdsRelatedToMonthlyPL = new HashSet<>();

		monthlyFSCellCodes.forEach(c -> {
			String codeIdentifier = c.getAdditionalInfo().get(additionInfoField_codeIdentifier);
			if(Integer.parseInt(c.getAdditionalInfo().get(additionInfoField_month)) == fsrContext.getFromMonth()){
				String expression = oemFsCellContext.getCodeIdentifierVsExpressionMap().get(codeIdentifier);
				codesRelatedToMonthlyPL.addAll(OemFSUtils.getCodesFromExpression(expression));
			}
		});

		codesRelatedToMonthlyPL.forEach(c -> {
			try{
				glIdsRelatedToMonthlyPL.addAll(
						TCollectionUtils.nullSafeEmptyList(
								oemFsCellContext.getGroupCodeVsGlAccountsMap()
										.get(oemFsCellContext.getCodeVsCellInfoMap().get(c).getGroupCode())));
			}catch (Exception e){
				log.error(String.format("something wrong with this cell code %s", c));
				throw new RuntimeException(e);
			}
		});

		fsrContext.setGlIdsRelatedToMonthlyPL(glIdsRelatedToMonthlyPL);
		Map<Integer, Map<String, Map<String, BigDecimal>>> glBalCntInfoForFS = getGlBalCntInfoForFS(fsrContext.toAccountingFSRContext());

		Set<Integer> validMonths = TimeUtils.getMonthsBetween(fsrContext.getFromYear(),
				fsrContext.getFromMonth()-1, fsrContext.getRequestedYear(), fsrContext.getRequestedMonth()-1);


		for (AccountingOemFsCellCode monthlyFsCellCode : monthlyFSCellCodes) {

			int cellMonth = Integer.parseInt(monthlyFsCellCode.getAdditionalInfo().get(additionInfoField_month));

			if(validMonths.contains(cellMonth-1)) {
				computeMonthlyFsCellCodeValue(oemFsCellContext, glBalCntInfoForFS, monthlyFsCellCode);
			}else{
				oemFsCellContext.getCodeVsDetailsMap().put(monthlyFsCellCode.getCode(),
						FsCodeDetail.builder()
								.value(BigDecimal.ZERO)
								.derived(true)
								.dependentFsCellCodes(monthlyFsCellCode.getDependentFsCellCodes())
								.build());
				oemFsCellContext.getCodeVsValueMap().put(monthlyFsCellCode.getCode(), BigDecimal.ZERO);
			}
		}
		// End : monthly code's values
		// Start : calculating values for derived code
		derivedFSCellCode.forEach(c -> {
			if (oemFsCellContext.getCodeVsDetailsMap().containsKey(c.getCode())) {
				return;
			}
			oemFsCellContext.setFsCellCode(c);
			computeDerivedCellValue(oemFsCellContext);
		});

		// End : calculating values for derived code
		return FsCellCodeDetailsResponseDto.builder().accountingOemFsCellCodes(fsCellCodes)
				.codeVsDetailsMap(oemFsCellContext.getCodeVsDetailsMap())
				.build();
	}

	private void computeNonDerivedCellCodes(OemFsCellContext oemFsCellContext, List<AccountingOemFsCellCode> nonDerivedFSCellCodes, Map<String, List<String>> groupCodeVsGlAccountsMap){
		nonDerivedFSCellCodes.forEach(c -> {
			oemFsCellContext.setFsCellCode(c);
			String code = c.getCode();
			String groupCode = c.getGroupCode();
			FsCellCodeSource fsCellCodeSource = c.getSource() == null?FsCellCodeSource.TRIAL_BALANCE:c.getSource();
			if(oemFsCellContext.getCodeVsDetailsMap().containsKey(code)){
				return;
			}
			FsCodeDetail fsCodeDetail = null;
			switch (fsCellCodeSource){
				case MEMO_WRKSHT:
					fsCodeDetail = computeNonDerivedForMemo(oemFsCellContext);
					break;
				case HEADCOUNT_WRKSHT:
					// TODO
					fsCodeDetail = computeNonDerivedForHC(oemFsCellContext);
					break;
				case DEALER_CONFIG:
					return;
				case DATE_MONTH:
					fsCodeDetail = getCodeDetailsForDateMonth(oemFsCellContext);
					break;

				case CUSTOM_SOURCE:
					fsCodeDetail = getDetailsForCustomSource(oemFsCellContext, c);
					break;

				default://TRIAL_BALANCE
					if(!groupCodeVsGlAccountsMap.containsKey(groupCode)){
						fsCodeDetail = FsCodeDetail.builder().value(getValueWithPrecision(BigDecimal.ZERO, oemFsCellContext)).build();
					}else{
						fsCodeDetail= computeNonDerivedCellValue(oemFsCellContext);
					}
			}

			if(fsCodeDetail == null){
				log.error("Looks like an invalid config {} {} {}",code,groupCode,c);
				return; // how did we end here.
			}
			oemFsCellContext.getCodeVsDetailsMap().put(code, fsCodeDetail);
			oemFsCellContext.getCodeVsValueMap().put(code, fsCodeDetail.getValue());
		});
	}

	private void fetchSnapshotValues(FsReportContext fsrContext, OemFsCellContext oemFsCellContext ){
		Set<String> monthlyCellCodes = oemFsCellContext.getMonthlyCodes();
		List<OEMFsCellCodeSnapshot> snapshots = oemFsCellCodeSnapshotRepo.findSnapshotByCodes(
				fsrContext.getFsId(), monthlyCellCodes, UserContextProvider.getCurrentDealerId());
		log.info("fId {} monthly cell codes {} dealerId {} snapshots {}", fsrContext.getFsId(), monthlyCellCodes.size(), UserContextProvider.getCurrentDealerId(), (long) snapshots.size());
		log.info("monthly cell codes {}", JsonUtil.toJson(monthlyCellCodes));

		Map<Integer, Map<String, OEMFsCellCodeSnapshot>> monthToCellCodeSnapshots = snapshots.stream().collect(
				groupingBy(OEMFsCellCodeSnapshot::getMonth, Collectors.toMap(OEMFsCellCodeSnapshot::getCode, x -> x, (oldValue, newValue) -> newValue)));
		oemFsCellContext.setMonthToCellCodeSnapshots(monthToCellCodeSnapshots);
		log.info("cell code snapshots months {}", JsonUtil.toJson(monthToCellCodeSnapshots.keySet()));
	}

	private FsCellCodeDetailsResponseDto getFsDetailsReportWithRoundOff(FsReportContext fsrContext) {

		//log.info("IN getFsCellCodeDetailsReport time {}, FsReportContext {}", System.currentTimeMillis(), fsrContext);
		log.info("calculating FS Values with roundOff offsetting!");

		List<AccountingOemFsCellCode> fsCellCodes =
				getOemTMappingListFromCache(fsrContext.getOemId(), fsrContext.getOemFsYear(), fsrContext.getVersion(), dealerConfig.getDealerCountryCode());

		Map<String, AccountingOemFsCellCode> codeVsCellInfoMap = TCollectionUtils.transformToMap(fsCellCodes, AccountingOemFsCellCode::getCode);

		List<AccountingOemFsCellCode> derivedFSCellCodes = Lists.newArrayList();
		List<AccountingOemFsCellCode> nonDerivedFSCellCodes = Lists.newArrayList();
		List<AccountingOemFsCellCode> monthlyFSCellCodes = Lists.newArrayList();
		Map<String, List<String>> groupCodeVsGlAccountsMap = getGlAccountsForFsCellGroups(fsrContext);
		Map<String, MemoWorksheet> memoKeyToWorksheetMap = getMemoWorksheetMap(fsrContext);
		Map<String, HCWorksheet> hcKeyToWorksheetmap = getHCWorksheetMap(fsrContext);
		OemConfig oemConfig = getOemConfig(fsrContext.getOemId());
		List<AccountingOemFsCellCode> roundOffCells = new ArrayList<>();
		Set<String> monthlyCodes = new HashSet<>();

		OemFsCellContext oemFsCellContext = OemFsCellContext.builder()
				.requestedYear(fsrContext.getRequestedYear())
				.requestedMonth(fsrContext.getRequestedMonth())
				.codeVsCellInfoMap(codeVsCellInfoMap)
				.groupCodeVsGlAccountsMap(groupCodeVsGlAccountsMap)
				.trialBalanceRowMap(fsrContext.getTrialBalanceRowMap())
				.memoKeyToValueMap(memoKeyToWorksheetMap)
				.hcKeyValueMap(hcKeyToWorksheetmap)
				.roundOff(getRoundOffProperty(oemConfig))
				.defaultPrecision(getDefaultPrecision(fsrContext.getOemId(), oemConfig))
				.derivedFSCellCodes(derivedFSCellCodes)
				.nonDerivedFSCellCodes(nonDerivedFSCellCodes)
				.monthlyFSCellCodes(monthlyFSCellCodes)
				.fsCellCodes(fsCellCodes)
				.monthlyCodes(monthlyCodes)
				.oemConfig(oemConfigRepo.findByOemId(fsrContext.getOemId(), dealerConfig.getDealerCountryCode()))
				.accountingInfo(aiService.find(UserContextProvider.getCurrentDealerId()))
				.fsTime(fsrContext.getFsTime())
				.build();

		fsCellCodes.forEach(c -> {
			if (c.isDerived()) {
				derivedFSCellCodes.add(c);
				oemFsCellContext.getCodeVsExpressionMap().put(c.getCode(), "(" + c.getExpression() + ")");
				if (OemCellSubType.MONTHLY.name().equalsIgnoreCase(c.getSubType())) {
					monthlyCodes.add(c.getCode());
					if (Integer.parseInt(c.getAdditionalInfo().get(additionInfoField_month)) != oemFsCellContext.getRequestedMonth()) {
						monthlyFSCellCodes.add(c);
					}
				}
			}else{
				if(FsCellCodeSource.ROUNDOFF_OFFSET.equals(c.getSource())){
					roundOffCells.add(c);
				}else{
					nonDerivedFSCellCodes.add(c);
				}

			}
		});

		FsCellCodeDetailsResponseDto roundOffDto = calculateCellCodeDetails(oemFsCellContext, fsrContext);
		mergeFSDetails(roundOffDto, roundOffDto, ROUNDED_VALUE);

		if(TCollectionUtils.isEmpty(roundOffCells)){
			log.warn("RoundOff offset config in cell codes is missing for {} {}", fsrContext.getOemId(), fsrContext.getFromYear());
			return roundOffDto;
		}

		AccountingOemFsCellCode cell = roundOffCells.get(0);
		String minuendCellCode = cell.getAdditionalInfo().get(OemConfig.FIRST_CODE);
		String subtrahendCellCode = cell.getAdditionalInfo().get(OemConfig.SECOND_CODE);
		String memoKey = cell.getAdditionalInfo().get(OemConfig.MEMO_KEY);
		if(Objects.nonNull(oemFsCellContext.getAccountingInfo())
				&& TCollectionUtils.isNotEmpty(oemFsCellContext.getAccountingInfo().getOemToOffsetCellMap())
				&& Objects.nonNull(oemFsCellContext.getAccountingInfo().getOemToOffsetCellMap().get(fsrContext.getOemId()))){

			memoKey = oemFsCellContext.getAccountingInfo().getOemToOffsetCellMap().get(fsrContext.getOemId());
			log.info("memo key {} to offset using from accountingInfo", memoKey);
		}

		if (Objects.isNull(memoKey) || Objects.isNull(minuendCellCode) || Objects.isNull(subtrahendCellCode)) {
			log.info("minuendCellCode {} subtrahendCellCode {} memoKey {}", minuendCellCode, subtrahendCellCode, memoKey);
			log.error("some data is missing in OemConfig for offset roundOff for oem {}", oemConfig.getOemId());
			return roundOffDto;
		}

		MemoWorksheet mWorksheet = memoKeyToWorksheetMap.get(memoKey);

		if(Objects.isNull(mWorksheet) || TCollectionUtils.isEmpty(mWorksheet.getValues())){
			log.error("memo migration is missing for key {} for {} {}", memoKey, fsrContext.getOemId(), fsrContext.getFromYear());
			return roundOffDto;
		}

		// if we round off at GlAccount level, offsetting value should be diff between liabilities and assets
		if(FinancialStatementUtils.isRoundOffGLBalances(fsrContext)){
			return computeFsDetailsWithGLRoundOff(fsrContext, mWorksheet, oemFsCellContext, roundOffDto, minuendCellCode, subtrahendCellCode);
		}

		FsCellCodeDetailsResponseDto nonRoundOffDto = roundOffDto;

		if (oemFsCellContext.isRoundOff()) {
			log.info("calculating cellCode details without roundOff");
			oemFsCellContext.setRoundOff(false);
			nonRoundOffDto = calculateCellCodeDetails(oemFsCellContext, fsrContext);
		}

		mergeFSDetails(nonRoundOffDto, roundOffDto, ORIGINAL_VALUE);

		try {
			BigDecimal firstDiff = roundOffDto.getCodeVsDetailsMap().get(minuendCellCode).getValue().subtract(
					roundOffDto.getCodeVsDetailsMap().get(minuendCellCode).getOriginalValue());
			BigDecimal secondDiff = roundOffDto.getCodeVsDetailsMap().get(subtrahendCellCode).getValue().subtract(
					roundOffDto.getCodeVsDetailsMap().get(subtrahendCellCode).getOriginalValue());

			BigDecimal diff = firstDiff.subtract(secondDiff);
			BigDecimal diff1 = firstDiff.setScale(0, BigDecimal.ROUND_HALF_UP)
					.subtract(secondDiff.setScale(0, BigDecimal.ROUND_HALF_UP));
			log.info("firstDiff {}, secondDiff {}, {} ~ {}, roundedDiffsDiff {}", firstDiff, secondDiff, diff,
					diff1.setScale(0, BigDecimal.ROUND_HALF_UP), diff1);

			if (diff1.compareTo(BigDecimal.ZERO) == 0) {
				mergeFSDetails(roundOffDto, roundOffDto, OFFSET_VALUE);
				return roundOffDto;
			}

			computeFsDetailsWithOffset(fsrContext, mWorksheet, diff1, oemFsCellContext, roundOffDto);

		} catch (Exception e) {
			log.error("Error while Offsetting RoundOff ", e);
		}

		return roundOffDto;
	}

	FsCellCodeDetailsResponseDto computeFsDetailsWithGLRoundOff(FsReportContext fsrContext, MemoWorksheet mWorksheet,
																OemFsCellContext oemFsCellContext, FsCellCodeDetailsResponseDto roundOffDto,
																String minuendCellCode, String subtrahendCellCode){
		try {
			BigDecimal firstValue = roundOffDto.getCodeVsDetailsMap().get(minuendCellCode).getValue();
			BigDecimal secondValue = roundOffDto.getCodeVsDetailsMap().get(subtrahendCellCode).getValue();
			BigDecimal diff = firstValue.subtract(secondValue);

			log.info("firstValue {}, secondValue {}, diff: {}", firstValue, secondValue, diff);

			if (diff.compareTo(BigDecimal.ZERO) == 0) {
				mergeFSDetails(roundOffDto, roundOffDto, OFFSET_VALUE);
				return roundOffDto;
			}

			computeFsDetailsWithOffset(fsrContext, mWorksheet, diff, oemFsCellContext, roundOffDto);

		} catch (Exception e) {
			log.error("Error while Offsetting RoundOff1 ", e);
		}

		return roundOffDto;
	}

	void computeFsDetailsWithOffset(FsReportContext fsrContext, MemoWorksheet mWorksheet, BigDecimal diff1,
									OemFsCellContext oemFsCellContext, FsCellCodeDetailsResponseDto roundOffDto){

		MemoValue mValue = mWorksheet.getValues().get(fsrContext.getRequestedMonth() - 1);
		mValue.setMtdValue(mValue.getMtdValue().add(diff1));
		mValue.setYtdValue(mValue.getYtdValue().add(diff1));

		oemFsCellContext.setRoundOff(true);
		FsCellCodeDetailsResponseDto responseDto = calculateCellCodeDetails(oemFsCellContext, fsrContext);
		mergeFSDetails(responseDto, roundOffDto, OFFSET_VALUE);
	}

	boolean isRoundOffAndOffset(OemConfig oemConfig, AccountingInfo accountingInfo){
		if(getRoundOffProperty(oemConfig)){
			if((Objects.nonNull(accountingInfo) && Objects.nonNull(accountingInfo.getFsRoundOffOffset()))){
				return accountingInfo.getFsRoundOffOffset();
			}
			return oemConfig.isEnableRoundOffOffset();
		}
		return false;
	}

	FsCellCodeDetailsResponseDto calculateCellCodeDetails(OemFsCellContext oemFsCellContext, FsReportContext fsrContext){
		removePreviouslyCalculatedValues(oemFsCellContext);
		List<AccountingOemFsCellCode> fsCellCodes = oemFsCellContext.getFsCellCodes();
		List<AccountingOemFsCellCode> derivedFSCellCode = oemFsCellContext.getDerivedFSCellCodes();
		List<AccountingOemFsCellCode> monthlyFSCellCodes = oemFsCellContext.getMonthlyFSCellCodes();
		List<AccountingOemFsCellCode> nonDerivedFSCellCodes = oemFsCellContext.getNonDerivedFSCellCodes();
		Map<String, List<String>> groupCodeVsGlAccountsMap = oemFsCellContext.getGroupCodeVsGlAccountsMap();
		Map<Integer, Map<String, Map<String, BigDecimal>>> glBalCntInfoForFS = oemFsCellContext.getGlBalCntInfoForFS();

		// Start : non-derived codes
		computeNonDerivedCellCodes(oemFsCellContext, nonDerivedFSCellCodes ,groupCodeVsGlAccountsMap);
		// End : non-derived codes
		// Start : monthly code's values

		monthlyFSCellCodes.forEach(c ->{
			if(Integer.parseInt(c.getAdditionalInfo().get(additionInfoField_month)) == fsrContext.getFromMonth()){
				oemFsCellContext.setFsCellCode(c);
				computeMonthlyExpressions(oemFsCellContext);
			}
		});

		if(FinancialStatementUtils.useSnapshotValuesInFS(oemFsCellContext)){
			fetchSnapshotValues(fsrContext, oemFsCellContext);
		}

		Set<String> codesRelatedToMonthlyPL = new HashSet<>();
		Set<String> glIdsRelatedToMonthlyPL = new HashSet<>();

		monthlyFSCellCodes.forEach(c -> {
			String codeIdentifier = c.getAdditionalInfo().get(additionInfoField_codeIdentifier);

			if(Integer.parseInt(c.getAdditionalInfo().get(additionInfoField_month)) == fsrContext.getFromMonth()){
				String expression = oemFsCellContext.getCodeIdentifierVsExpressionMap().get(codeIdentifier);
				codesRelatedToMonthlyPL.addAll(OemFSUtils.getCodesFromExpression(expression));
			}
		});

		codesRelatedToMonthlyPL.forEach(c -> {
			try{
				glIdsRelatedToMonthlyPL.addAll(
						TCollectionUtils.nullSafeEmptyList(
								oemFsCellContext.getGroupCodeVsGlAccountsMap()
										.get(oemFsCellContext.getCodeVsCellInfoMap().get(c).getGroupCode())));
			}catch (Exception e){
				log.error(String.format("something wrong with this cell code %s", c));
				throw new RuntimeException(e);
			}
		});

		if(TCollectionUtils.isEmpty(glBalCntInfoForFS)){
			fsrContext.setGlIdsRelatedToMonthlyPL(glIdsRelatedToMonthlyPL);
			glBalCntInfoForFS = getGlBalCntInfoForFS(fsrContext.toAccountingFSRContext());
			oemFsCellContext.setGlBalCntInfoForFS(glBalCntInfoForFS);
		}

		Set<Integer> validMonths = TimeUtils.getMonthsBetween(fsrContext.getFromYear(),
				fsrContext.getFromMonth()-1, fsrContext.getRequestedYear(), fsrContext.getRequestedMonth()-1);

		for (AccountingOemFsCellCode monthlyFsCellCode : monthlyFSCellCodes) {

			int cellMonth = Integer.parseInt(monthlyFsCellCode.getAdditionalInfo().get(additionInfoField_month));

			if(validMonths.contains(cellMonth-1)) {
				computeMonthlyFsCellCodeValue(oemFsCellContext, glBalCntInfoForFS, monthlyFsCellCode);

			}else{
				oemFsCellContext.getCodeVsDetailsMap().put(monthlyFsCellCode.getCode(),
						FsCodeDetail.builder()
								.value(BigDecimal.ZERO)
								.derived(true)
								.dependentFsCellCodes(monthlyFsCellCode.getDependentFsCellCodes())
								.build());
				oemFsCellContext.getCodeVsValueMap().put(monthlyFsCellCode.getCode(), BigDecimal.ZERO);
			}
		}
		// End : monthly code's values
		// Start : calculating values for derived code
		derivedFSCellCode.forEach(c -> {
			if (oemFsCellContext.getCodeVsDetailsMap().containsKey(c.getCode())) {
				return;
			}
			oemFsCellContext.setFsCellCode(c);
			computeDerivedCellValue(oemFsCellContext);
		});

		return  FsCellCodeDetailsResponseDto.builder().accountingOemFsCellCodes(fsCellCodes)
				.codeVsDetailsMap(oemFsCellContext.getCodeVsDetailsMap())
				.build();
	}

	private void compare(FsCellCodeDetailsResponseDto roundOffDto, FsCellCodeDetailsResponseDto oldResponseDto) {
		for(String s: oldResponseDto.getCodeVsDetailsMap().keySet()){
			if(roundOffDto.getCodeVsDetailsMap().get(s) == null){
				log.error("FS CellCode value missing {}", s);
			}else if(roundOffDto.getCodeVsDetailsMap().get(s).getValue().compareTo(oldResponseDto.getCodeVsDetailsMap().get(s).getValue()) != 0){
				log.error("FS values not matching for cellCode: {}, {} <> {}", s, roundOffDto.getCodeVsDetailsMap().get(s).getValue()
						, oldResponseDto.getCodeVsDetailsMap().get(s).getValue());
			}
		}
	}

	private void removePreviouslyCalculatedValues(OemFsCellContext oemFsCellContext) {
		oemFsCellContext.setCodeVsDetailsMap(new HashMap<>());
		oemFsCellContext.setCodeVsValueMap(new HashMap<>());
	}

	void mergeFSDetails(FsCellCodeDetailsResponseDto nonRoundOffDto, FsCellCodeDetailsResponseDto roundOffDto, String type){
		Map<String, FsCodeDetail> roundOffValuesMap = roundOffDto.getCodeVsDetailsMap();
		Map<String, FsCodeDetail> otherValuesMap = nonRoundOffDto.getCodeVsDetailsMap();
		for(String cellCode: roundOffValuesMap.keySet()){
			switch (type){
				case OFFSET_VALUE:
					roundOffValuesMap.get(cellCode).setValueAfterOffset(otherValuesMap.get(cellCode).getValue());
					roundOffValuesMap.get(cellCode).setValue(otherValuesMap.get(cellCode).getValue());
					break;
				case ORIGINAL_VALUE:
					roundOffValuesMap.get(cellCode).setOriginalValue(otherValuesMap.get(cellCode).getValue());
					break;
				case ROUNDED_VALUE:
					roundOffValuesMap.get(cellCode).setRoundedValue(otherValuesMap.get(cellCode).getValue());
					break;
			}
		}
	}

	private FsCodeDetail getCodeDetailsForDateMonth(OemFsCellContext oemFsCellContext) {
		return FsCodeDetail.builder().value(new BigDecimal(oemFsCellContext.getRequestedMonth())).build();
	}

	private FsCodeDetail getDetailsForCustomSource(OemFsCellContext oemFsCellContext, AccountingOemFsCellCode cell) {
		String customSourceType = cell.getAdditionalInfo().get(SOURCE_TYPE);
		String value = null;
		switch (customSourceType){
			case "CITY_STATE":
				value = dealerConfig.getDealerCityState();
				break;
			case "ADDRESS":
				value = dealerConfig.getDealerPostBox();
				break;
			case "DEALER_NAME":
				value = dealerConfig.getDealerName();
				break;
			case "FROM_DATE":
				value = TimeUtils.getStringFromEpoch(TimeUtils.getYearStart(oemFsCellContext.getFsTime()), NCT_DATE_FORMAT);;
				break;
			case "TO_DATE":
				value = TimeUtils.getStringFromEpoch(oemFsCellContext.getFsTime(), NCT_DATE_FORMAT);
				break;
			default:
				log.warn("unhandled CUSTOM_SOURCE type in FS cell {}", customSourceType);

		}
		return FsCodeDetail.builder().stringValue(value).build();
	}

	private Map<String, HCWorksheet> getHCWorksheetMap(FsReportContext fsrContext) {
		List<HCWorksheet> hcWorksheets = hcWorksheetRepo.findByFsId(fsrContext.getFsId());
		return TCollectionUtils.transformToMap(TCollectionUtils.nullSafeCollection(hcWorksheets), (hc)->{
			return hc.getDepartment()+"_"+hc.getPosition();
		});

	}

	private Map<String, MemoWorksheet> getMemoWorksheetMap(FsReportContext fsrContext) {
		if(!fsrContext.isFsByFiscalYear()){
			return TCollectionUtils.transformToMap(TCollectionUtils.nullSafeCollection(
					memoWorksheetRepo.findForOemByYearOptimized(fsrContext.getFsId(), getCurrentDealerId())), MemoWorksheet::getKey);
		}

		Set<Integer> years = new HashSet<>();
		years.add(fsrContext.getFromYear());
		years.add(fsrContext.getRequestedYear());

		List<MemoWorksheet> fullList = memoWorksheetRepo.findForOemByYearsOptimized(fsrContext.getFsId(), getCurrentDealerId());

		//log.info(" <----> fullMemoList {}", JsonUtil.toJson(fullList));

		List<MemoWorksheet> reqYearList = fullList.stream().filter(e -> e.getYear() == fsrContext.getRequestedYear()).collect(Collectors.toList());

		Map<String, List<MemoWorksheet>> map = new HashMap<>();

		fullList.forEach(memo -> map.computeIfAbsent(memo.getKey(), k -> new ArrayList<>()).add(memo));

		for(List<MemoWorksheet> sheets: map.values()){
			updateMemoWorksheetsByFY(sheets, fsrContext);
		}

		return TCollectionUtils.transformToMap(TCollectionUtils.nullSafeCollection(reqYearList), MemoWorksheet::getKey);
	}

	private List<String> getGlAccountsForFsCellCode(String cellCode, OemFsCellContext oemFsCellContext) {
		List<String> glAccounts = Lists.newArrayList();
		glAccounts.addAll(
				TCollectionUtils.nullSafeEmptyList(
						oemFsCellContext.getGroupCodeVsGlAccountsMap()
								.get(oemFsCellContext.getCodeVsCellInfoMap().get(cellCode).getGroupCode())));
		return glAccounts;
	}

	private void computeMonthlyFsCellCodeValue(OemFsCellContext context, Map<Integer ,Map<String, Map<String, BigDecimal>>> glBalCntInfoForFS, AccountingOemFsCellCode monthlyFsCellCode) {

		BigDecimal cellValue = BigDecimal.ZERO;
		Map<String, BigDecimal> cellCodeToValueMap = Maps.newHashMap();
		String codeIdentifier = monthlyFsCellCode.getAdditionalInfo().get(additionInfoField_codeIdentifier);

		for (String dependentFsCellCode : OemFSUtils.getCodesFromExpression(context.getCodeIdentifierVsExpressionMap().get(codeIdentifier))) {
			BigDecimal dependentCellValue = BigDecimal.ZERO;
			dependentCellValue = getDependentCellValue(context, glBalCntInfoForFS, dependentFsCellCode, monthlyFsCellCode);
			cellCodeToValueMap.put(dependentFsCellCode, dependentCellValue);
		}
		String expression = OemFSUtils.getExpressionReplacedByValues(context.getCodeIdentifierVsExpressionMap().get(codeIdentifier), cellCodeToValueMap);

		BigDecimal snapshotValue = null;
		if(FinancialStatementUtils.useSnapshotValuesInFS(context)){
			snapshotValue = FinancialStatementUtils.getSnapshotValue(monthlyFsCellCode, context);
		}

		if (Objects.isNull(snapshotValue)) {
			cellValue = getValueWithPrecision(OemFSUtils.getCalculatedAmount(expression), context);
		}else{
			cellValue = snapshotValue;
		}

		context.getCodeVsDetailsMap().put(monthlyFsCellCode.getCode(),
				FsCodeDetail.builder()
						.value(cellValue)
						.derived(true)
						.dependentFsCellCodes(monthlyFsCellCode.getDependentFsCellCodes())
						.build());
		context.getCodeVsValueMap().put(monthlyFsCellCode.getCode(), cellValue);
	}

	private BigDecimal getDependentCellValue(OemFsCellContext context, Map<Integer ,Map<String, Map<String, BigDecimal>>> glBalCntInfoForFS, String dependentFsCellCodeName, AccountingOemFsCellCode fSCellCode) {

		List<String> glAccountsForFsCellCode = getGlAccountsForFsCellCode(dependentFsCellCodeName, context);

		AccountingOemFsCellCode dependentFsCellCode = context.getCodeVsCellInfoMap().get(dependentFsCellCodeName);

		BigDecimal cellValue = BigDecimal.ZERO;
		Integer month = Integer.parseInt(fSCellCode.getAdditionalInfo().get(additionInfoField_month));

		for (String glAccount : glAccountsForFsCellCode) {
			BigDecimal glAccountValue = BigDecimal.ZERO;
			glAccountValue = glBalCntInfoForFS.get(month-1).get(glAccount).get(dependentFsCellCode.getValueType() + "_" + dependentFsCellCode.getDurationType());
			cellValue = cellValue.add(glAccountValue);
		}
		return cellValue;
	}

	public boolean isFutureMonth(MonthInfo activeMonthInfo, int year, int month) {
		if((activeMonthInfo.getYear() > year || (activeMonthInfo.getYear() == year && month <= activeMonthInfo.getMonth())
				|| isPostAheadMonth(activeMonthInfo.getYear(), activeMonthInfo.getMonth(), year, month))){
			return false;
		}
		return true;
	}

	private boolean isPostAheadMonth(Integer activeYear, Integer activeMonth, int year, int month) {
		if(activeMonth == 11){
			if((year == activeYear+1) && month == 0){
				return true;
			}
		}else{
			if(year == activeYear && month == activeMonth+1){
				return  true;
			}
		}
		return false;
	}

	@Override
	public List<AccountingOemFsCellCode> saveFsCellCodes(FSCellCodeListCreateDto reqDto) {

		List<String> codes = reqDto.getFsCellCodeDetails().stream().map(FSCellCodeInfoRequest::getCode).collect(Collectors.toList());
		Map< String, FSCellCodeInfoRequest> codeToFSCellCodeMap = TCollectionUtils.transformToMap(reqDto.getFsCellCodeDetails(), FSCellCodeInfoRequest::getCode);

		List<AccountingOemFsCellCode> fsCellCodeList = TCollectionUtils.nullSafeList(fsCellCodeRepo.getFsCellCodesForOemYearAndCountry(reqDto.getOemId().name(), reqDto.getYear(), reqDto.getVersion(), reqDto.getCountry()));
		Map<String, AccountingOemFsCellCode> fsCodeToCellInfoMapInDb = TCollectionUtils.transformToMap(fsCellCodeList, AccountingOemFsCellCode::getCode);

		List<AccountingOemFsCellCode> fsCodesToSave = Lists.newArrayList();
		for(String code : codes){
			if(fsCodeToCellInfoMapInDb.containsKey(code)){
				reqDto.applyFieldsToExistingFsCellCode(fsCodeToCellInfoMapInDb.get(code), codeToFSCellCodeMap.get(code));
				fsCodesToSave.add(fsCodeToCellInfoMapInDb.get(code));
			}else{
				fsCodesToSave.add(reqDto.toFsCellCode(codeToFSCellCodeMap.get(code)));
			}
		}
		fsCellCodeRepo.updateBulk(fsCodesToSave);
		return fsCellCodeRepo.findByCodesAndDealerIdAndOemIdNonDeleted(codes, reqDto.getYear(), reqDto.getOemId().name(), reqDto.getCountry());
	}

	@Override
	public void saveTemplate(OemTemplateReqDto reqDto) {

		List<OemTemplate> oemTemplateList = Lists.newArrayList();
		for (TemplateDetail templateDetail : reqDto.getTemplateDetails()) {

			OemTemplate oemTemplate =  OemTemplate.builder()
					.oemId(templateDetail.getOemId().name())
					.year(templateDetail.getYear())
					.country(templateDetail.getCountry())
					.template(templateDetail.getTemplate())
					.createdByUserId(UserContextProvider.getCurrentUserId())
					.modifiedByUserId(UserContextProvider.getCurrentUserId())
					.active(templateDetail.isActive())
					.version(templateDetail.getVersion())
					.build();

			oemTemplate.setCreatedTime(System.currentTimeMillis());
			oemTemplate.setModifiedTime(System.currentTimeMillis());

			if(templateDetail.isActive()){
				oemTemplateRepo.updateTemplatesAsInactive(templateDetail.getOemId().name(), templateDetail.getYear(), templateDetail.getCountry());
			}
			oemTemplateList.add(oemTemplate);
		}
		oemTemplateRepo.updateBulk(oemTemplateList);
	}

	@Override
	public List<OemTemplate> getOemTemplate(String oemId, Integer year) {
		return oemTemplateRepo.findActiveTemplateByOemYearAndCountry(oemId, year, dealerConfig.getDealerCountryCode());
	}

	@Override
	public AccountingOemFsCellGroup saveFsCellGroupCode(FSCellGroupCodeCreateDto reqDto) {
		AccountingOemFsCellGroup oemFSCellGroup = reqDto.toOemFSCellGroup();
		return oemFsCellGroupRepo.save(oemFSCellGroup);
	}

	@Override
	public List<AccountingOemFsCellGroup> fetchFsCellGroupCodes(String oemId, Integer year, Integer version) {
		return oemFsCellGroupRepo.findNonDeletedByOemIdYearVersionAndCountry(oemId, year, version, dealerConfig.getDealerCountryCode());
	}

	@Override
	public List<AccountingOemFsCellGroup> fetchFsCellGroupCodesInBulk(Integer year, Set<OEM> oemIds) {
		Set<String> oems = TCollectionUtils.nullSafeCollection(oemIds).stream().map(OEM::name).collect(Collectors.toSet());
		return oemFsCellGroupRepo.findByOemIdsAndYearNonDeleted(oems, year, dealerConfig.getDealerCountryCode());
	}

	@Override
	public void saveFsCellGroupCodes(FSCellGroupCodesCreateDto reqDto) {
		List<AccountingOemFsCellGroup> oemFSCellGroups = reqDto.toOemFSCellGroupList();
		oemFsCellGroupRepo.insertBulk(oemFSCellGroups);
	}

	@Override
	public void upsertFsCellGroupCodes(FSCellGroupCodesCreateDto reqDto) {
		List<AccountingOemFsCellGroup> oemFSCellGroups = reqDto.toOemFSCellGroupList();
		oemFsCellGroupRepo.upsertBulk(oemFSCellGroups);
	}

	@Override
	public void migrateFsCellCodesFromGroup(OEM oem) {
		List<AccountingOemFsCellGroup> groups = oemFsCellGroupRepo.findByOemId(oem.name(), dealerConfig.getDealerCountryCode());
		List<AccountingOemFsCellCode> codes = Lists.newArrayList();
		groups.forEach(g->{
			codes.add(getFsCellCodeFromGroup(g, OemCellValueType.BALANCE, OemCellDurationType.MTD));
			codes.add(getFsCellCodeFromGroup(g, OemCellValueType.BALANCE, OemCellDurationType.YTD));
			codes.add(getFsCellCodeFromGroup(g, OemCellValueType.COUNT, OemCellDurationType.MTD));
			codes.add(getFsCellCodeFromGroup(g, OemCellValueType.COUNT, OemCellDurationType.YTD));
		});
		fsCellCodeRepo.insertBulk(codes);
	}

	@Override
	public void createFsCellCodeSnapshotForYearAndMonth(CellCodeSnapshotCreateDto dto){
		FSEntry fsEntry = fsEntryRepo.findByIdAndDealerIdWithNullCheck(dto.getFsId(), getCurrentDealerId());
		createFsCellCodeSnapshot(fsEntry, Objects.isNull(dto.getOemFsYear()) ? fsEntry.getYear():dto.getOemFsYear() , dto.getMonth(), dto.isIncludeM13(), dto.isAddM13BalInDecBalances());
	}

	@Override
	public List<OEMFsCellCodeSnapshot> getFsCellCodeSnapshots(String fsId, Integer month_1_12){
		return oemFsCellCodeSnapshotRepo.findAllSnapshotByFsIdAndMonth(fsId, month_1_12, getCurrentDealerId());
	}


	@Override
	public void createFsCellCodeSnapshot(FSEntry fsEntry, int oemFsYear, int month, boolean includeM13, boolean addM13BalInDecBalances) {
		String oemId = fsEntry.getOemId();
		int year = fsEntry.getYear();
		int oemFsVersion = fsEntry.getVersion();
		List<OEMFsCellCodeSnapshot> oemExecutiveSnapshotList = Lists.newArrayList();
		DateTime monthStart = new DateTime(year, month, 1, 0,
				0, DateTimeZone.forID(dealerConfig.getDealerTimeZoneName()));

		if(Objects.nonNull(oemFsCellCodeSnapshotRepo.findOneSnapshotByFsIdAndMonth(fsEntry.getId(), month, getCurrentDealerId()))) {
			throw new TBaseRuntimeException(String.format("Snapshot already exists for oem %s, year %s, month %s", oemId, year, month));
		}
		FsCellCodeDetailsResponseDto fsCellCodeDetailsResponseDto = computeFsCellCodeDetails(oemId, oemFsYear, oemFsVersion, year, month, includeM13, fsEntry.getSiteId(), addM13BalInDecBalances);
		Map<String, FsCodeDetail> codeVsDetailsMap = fsCellCodeDetailsResponseDto.getCodeVsDetailsMap();
		if(TCollectionUtils.isEmpty(codeVsDetailsMap)){
			return;
		}
		codeVsDetailsMap.keySet().forEach(key -> {
			OEMFsCellCodeSnapshot oemFsCellCodeSnapshot = new OEMFsCellCodeSnapshot(fsEntry.getId(), year, month, getCurrentDealerId(),
					oemFsVersion, fsEntry.getSiteId(), fsEntry.getFsType());
			oemFsCellCodeSnapshot.setCreatedTime(System.currentTimeMillis());
			oemFsCellCodeSnapshot.setCode(key);
			oemFsCellCodeSnapshot.setTimestamp(monthStart.getMillis());
			oemFsCellCodeSnapshot.setOemId(oemId);
			oemFsCellCodeSnapshot.setValue(codeVsDetailsMap.get(key).getValue());
			oemExecutiveSnapshotList.add(oemFsCellCodeSnapshot);
		});
		oemFsCellCodeSnapshotRepo.saveBulkSnapshot(oemExecutiveSnapshotList);
	}

	public void createBulkFsCellCodeSnapshot(String siteId, String oemId, int oemFsYear, int oemFsVersion, int year, int fromMonth, int toMonth, boolean includeM13, boolean addM13BalInDecBalances) {
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		if(activeMonthInfo.getYear() == year && activeMonthInfo.getMonth()+1 <= toMonth) {
			throw new TBaseRuntimeException("Year and toMonth are invalid because snapshot cannot be create for current month");
		}
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, year, UserContextProvider.getCurrentDealerId(), siteId);
		while(year <= activeMonthInfo.getYear() && fromMonth <= toMonth) {
			createFsCellCodeSnapshot(fsEntry, oemFsYear, fromMonth, includeM13, addM13BalInDecBalances);
			log.info("Successfully created snapshot for Year {} & Month {}", year, fromMonth);
			fromMonth++;
		}
	}

	@Override
	public boolean deleteSnapshotByYearAndMonth(String siteId, String oemId, int oemFsVersion, int year, int month) {
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, year, UserContextProvider.getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		oemFsCellCodeSnapshotRepo.deleteSnapshotByFsIdAndMonth(fsEntry.getId(), month, getCurrentDealerId());
		return true;
	}

	@Override
	public boolean deleteBulkSnapshotByYearAndMonth(String siteId, String oemId, int year, int fromMonth, int toMonth) {
		oemFsCellCodeSnapshotRepo.deleteBulkSnapshotByYearAndMonth(oemId, year, fromMonth, toMonth, getCurrentDealerId(), siteId);
		return true;
	}

	@Override
	public OemConfig getOemConfig(String oemId) {
		return oemConfigRepo.findByOemId(oemId, dealerConfig.getDealerCountryCode());
	}

	@Override
	public OemConfig saveOemConfig(OemConfigRequestDto requestDto) {
		OemConfig oemConfigInDb = oemConfigRepo.findByOemId(requestDto.getOemId().name(), requestDto.getCountry());
		if (Objects.nonNull(oemConfigInDb)) {
			oemConfigInDb.setCountry(requestDto.getCountry());
			oemConfigInDb.setXmlEnabled(requestDto.isXmlEnabled());
			oemConfigInDb.setOemLogoURL(requestDto.getOemLogoURL());
			oemConfigInDb.setSubmissionEnabled(requestDto.isSubmissionEnabled());
			oemConfigInDb.setDefaultPrecision(requestDto.getDefaultPrecision());
			oemConfigInDb.setSupportedFileFormats(requestDto.getSupportedFileFormats().stream().map(OemConfig.SupportedFileFormats::name).collect(Collectors.toList()));
			oemConfigInDb.setUseDealerLogo(requestDto.isUseDealerLogo());
			oemConfigInDb.setAdditionalInfo(requestDto.getAdditionalInfo());
			oemConfigInDb.setDownloadFileFromIntegration(requestDto.isDownloadFileFromIntegration());
			oemConfigInDb.setEnableRoundOff(requestDto.isEnableRoundOff());
			oemConfigInDb.setEnableRoundOffOffset(requestDto.isEnableRoundOffOffset());
			oemConfigInDb.setModifiedByUserId(UserContextProvider.getCurrentUserId());
			oemConfigInDb.setModifiedTime(System.currentTimeMillis());
			return oemConfigRepo.save(oemConfigInDb);

		} else {
			OemConfig oemConfigToBeSaved = requestDto.createOemInfo();
			return oemConfigRepo.save(oemConfigToBeSaved);
		}
	}

	@Override
	public List<OEMFsCellCodeSnapshotResponseDto> getAllOEMFsCellCodeSnapshotSummary(String siteId, String oemId, int oemFsVersion, int year, int month, int oemFsYear, boolean includeM13, boolean addM13BalInDecBalances) {
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, year, UserContextProvider.getCurrentDealerId(), siteId);
		List<OEMFsCellCodeSnapshotResponseDto> oemFsCellCodeSnapshotResponseDtoList = Lists.newArrayList();
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		if(activeMonthInfo.getYear()>year || (activeMonthInfo.getYear() == year && activeMonthInfo.getMonth() > month-1) ) {
			List<OEMFsCellCodeSnapshot> oemFsCellCodeSnapshotList = oemFsCellCodeSnapshotRepo.findAllSnapshotByFsIdAndMonth(fsEntry.getId(), month, getCurrentDealerId());
			oemFsCellCodeSnapshotList.forEach(oemFsCellCodeSnapshot -> {
				OEMFsCellCodeSnapshotResponseDto oemFsCellCodeSnapshotResponseDto = new OEMFsCellCodeSnapshotResponseDto(
						oemFsCellCodeSnapshot.getCode(),
						oemFsCellCodeSnapshot.getValue());
				oemFsCellCodeSnapshotResponseDtoList.add(oemFsCellCodeSnapshotResponseDto);
			});
		} else {
			FsCellCodeDetailsResponseDto fsCellCodeDetailsResponseDto = computeFsCellCodeDetails(oemId, oemFsYear, oemFsVersion, year, month, includeM13, siteId, addM13BalInDecBalances);
			Map<String, FsCodeDetail> codeVsDetailsMap = fsCellCodeDetailsResponseDto.getCodeVsDetailsMap();
			codeVsDetailsMap.keySet().forEach(key -> {
				OEMFsCellCodeSnapshotResponseDto oemFsCellCodeSnapshotResponseDto = new OEMFsCellCodeSnapshotResponseDto(
						key, codeVsDetailsMap.get(key).getValue());
				oemFsCellCodeSnapshotResponseDtoList.add(oemFsCellCodeSnapshotResponseDto);
			});
		}
		return oemFsCellCodeSnapshotResponseDtoList;
	}

	@Override
	public List<OEMFsCellCodeSnapshotBulkResponseDto> getBulkOEMFsCellCodeSnapshot(String oemId, Set<String> codes, long fromTimestamp,
																				   long toTimestamp, int oemFsVersion, int oemFsYear, boolean includeM13, String siteId, boolean addM13BalInDecBalances) {
		List<OEMFsCellCodeSnapshotBulkResponseDto> oemFsCellCodeSnapshotBulkResponseDtoList = Lists.newArrayList();
		FsCellCodeDetailsResponseDto fsCellCodeDetailsResponseDto;
		DateTime dateTime = new DateTime(toTimestamp, DateTimeZone.forID(dealerConfig.getDealerTimeZoneName()));
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		int fromMonth = activeMonthInfo.getMonth() +1, toMonth = dateTime.getMonthOfYear(),
				currentYear = activeMonthInfo.getYear(), toYear = dateTime.getYear();

		oemFsCellCodeSnapshotRepo.getFsCellCodeByTimestamp(fromTimestamp, toTimestamp, codes, oemId, getCurrentDealerId(),siteId )
				.forEach( record -> {
					OEMFsCellCodeSnapshotBulkResponseDto dto = new OEMFsCellCodeSnapshotBulkResponseDto(
							record.getCode(), record.getValue(), record.getTimestamp()
					);
					oemFsCellCodeSnapshotBulkResponseDtoList.add(dto);
				});

		int requiredYear = currentYear;
		int requiredMonth = fromMonth;

		List<FSEntry> fsEntries = fsEntryRepo.findFsEntriesByYearRange(oemId, requiredYear, toYear, FSType.OEM.name(), UserContextProvider.getCurrentDealerId(), siteId);
		Map<Integer, FSEntry> oemYearVsEntryMap = TCollectionUtils.transformToMap(TCollectionUtils.nullSafeList(fsEntries) , FSEntry::getYear);
		while((requiredYear < toYear ) || (requiredYear == toYear && requiredMonth <= toMonth) ) {
			FSEntry fsEntry = oemYearVsEntryMap.get(requiredYear);
			if( requiredYear == toYear && requiredMonth == toMonth) {
				fsCellCodeDetailsResponseDto = computeFsCellCodeDetails(fsEntry, toTimestamp, false, addM13BalInDecBalances);
			} else {
				// passing oemFsYear and year as required Year
				fsCellCodeDetailsResponseDto  = computeFsCellCodeDetails(oemId, requiredYear, oemFsVersion,
						requiredYear, requiredMonth, includeM13, siteId, addM13BalInDecBalances);
			}

			// why dont we add end date of month here instead of starting date
			DateTime timestamp = new DateTime(requiredYear, requiredMonth, 1, 0,
					0, DateTimeZone.forID(dealerConfig.getDealerTimeZoneName()));
			Map<String, FsCodeDetail> codeVsDetailsMap = fsCellCodeDetailsResponseDto.getCodeVsDetailsMap();
			codeVsDetailsMap.keySet().forEach(key -> {
				if(codes.contains(key)) {
					OEMFsCellCodeSnapshotBulkResponseDto dto = new OEMFsCellCodeSnapshotBulkResponseDto(
							key, codeVsDetailsMap.get(key).getValue(), timestamp.getMillis());
					oemFsCellCodeSnapshotBulkResponseDtoList.add(dto);
				}
			});

			if(requiredMonth < 12){
				requiredMonth++;
			}else{
				requiredMonth = 1;
				requiredYear += 1;
			}
		}

		return oemFsCellCodeSnapshotBulkResponseDtoList;
	}

	@Override
	public List<OEMFsCellCodeSnapshotResponseDto> getOEMFsCellCodeSnapshot(String siteId, String oemId, int oemFsVersion, int year, int month,
																		   Set<String> codes, int oemFsYear, boolean includeM13, boolean addM13BalInDecBalances) {
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, oemFsYear, getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		List<OEMFsCellCodeSnapshotResponseDto> oemFsCellCodeSnapshotResponseDtoList = Lists.newArrayList();
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		if(activeMonthInfo.getYear()>year || (activeMonthInfo.getYear() == year && activeMonthInfo.getMonth() > month-1) ) {
			List<OEMFsCellCodeSnapshot> oemFsCellCodeSnapshotList = oemFsCellCodeSnapshotRepo.findSnapshotByCodesAndMonth(fsEntry.getId(), month, codes, getCurrentDealerId());
			oemFsCellCodeSnapshotList.forEach(oemFsCellCodeSnapshot -> {
				OEMFsCellCodeSnapshotResponseDto oemFsCellCodeSnapshotResponseDto = new OEMFsCellCodeSnapshotResponseDto(
						oemFsCellCodeSnapshot.getCode(),
						oemFsCellCodeSnapshot.getValue());
				oemFsCellCodeSnapshotResponseDtoList.add(oemFsCellCodeSnapshotResponseDto);
			});
		} else {
			FsCellCodeDetailsResponseDto fsCellCodeDetailsResponseDto = computeFsCellCodeDetails(oemId, oemFsYear, oemFsVersion, year, month, includeM13,siteId, addM13BalInDecBalances);
			Map<String, FsCodeDetail> codeVsDetailsMap = fsCellCodeDetailsResponseDto.getCodeVsDetailsMap();
			codeVsDetailsMap.keySet().forEach(key -> {
				if(codes.contains(key)) {
					OEMFsCellCodeSnapshotResponseDto oemFsCellCodeSnapshotResponseDto = new OEMFsCellCodeSnapshotResponseDto(
							key, codeVsDetailsMap.get(key).getValue());
					oemFsCellCodeSnapshotResponseDtoList.add(oemFsCellCodeSnapshotResponseDto);
				}
			});
		}

		return oemFsCellCodeSnapshotResponseDtoList;
	}

	@Override
	public void createFsMappingSnapshot(String fsId, int month) {
		FSEntry fsEntry = fsEntryRepo.findByIdAndDealerIdWithNullCheck(fsId, UserContextProvider.getCurrentDealerId());
		List<OemFsMappingSnapshot> fsMappingSnapshots = Lists.newArrayList();
		if(Objects.nonNull(oemFsMappingSnapshotRepo.findOneSnapshotByYearAndMonth(fsId, month, UserContextProvider.getCurrentDealerId()))) {
			throw new TBaseRuntimeException(String.format("Snapshot already exists for oem %s, year %s, month %s", fsEntry.getOemId(), fsEntry.getYear(), month));
		}
		List<OemFsMapping> currentOemMappings = oemFsMappingRepo.findMappingsByFsId(fsId, getCurrentDealerId());
		currentOemMappings.forEach(oemFsMapping -> {
			fsMappingSnapshots.add(OemFsMappingSnapshot.fromOemMapping(oemFsMapping, month, fsId));
		});
		oemFsMappingSnapshotRepo.saveBulkSnapshot(fsMappingSnapshots);
	}

	@Override
	public void createFsMappingSnapshotBulk(String siteId, String oemId, int oemFsYear, int oemFsVersion, int year, int fromMonth, int toMonth) {
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		if(activeMonthInfo.getYear() == year && activeMonthInfo.getMonth()+1 <= toMonth) {
			throw new TBaseRuntimeException("Year and toMonth are invalid because snapshot cannot be create for current month");
		}
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, year, UserContextProvider.getCurrentDealerId(), siteId);
		while(year <= activeMonthInfo.getYear() && fromMonth <= toMonth) {
			createFsMappingSnapshot(fsEntry.getId(), fromMonth);
			log.info("Successfully created FS mapping snapshot for Year {} & Month {}", year, fromMonth);
			fromMonth++;
		}
	}

	@Override
	public void createFsMappingAndCellCodeSnapshot(int year, int month, boolean includeM13, String siteId, boolean addM13BalInDecBalances) {
		List<FSEntry> fsEntries = fsEntryRepo.findFsEntriesForYear(year, getCurrentDealerId(),siteId);
		createAllSnapshots(fsEntries, year, month, includeM13, addM13BalInDecBalances);
	}

	@Override
	public void createFsMappingAndCellCodeSnapshotForAllSites(int year, int month, boolean includeM13, boolean addM13BalInDecBalances) {
		List<FSEntry> fsEntries = fsEntryRepo.findByKeyAtDealerLevel("year", year, getCurrentDealerId());
		createAllSnapshots(fsEntries, year, month, includeM13, addM13BalInDecBalances);
	}

	private void createAllSnapshots(List<FSEntry> fsEntries, int year, int month, boolean includeM13, boolean addM13BalInDecBalances){
		log.info("Taking mapping and cell codes snapshots for site {} {}", year, month);
		Map<String, FSEntry> oemToVersion = Maps.newHashMap();
		TCollectionUtils.nullSafeList(fsEntries).forEach(fsEntry -> {
			String key = fsEntry.getId();
			if (!oemToVersion.containsKey(key)) {
				oemToVersion.put(key, fsEntry);
			}
		});
		oemToVersion.keySet().forEach(key -> {
			FSEntry fsEntry = oemToVersion.get(key);
			try {
				createFsCellCodeSnapshot(fsEntry, year, month, includeM13, addM13BalInDecBalances);
				createFsMappingSnapshot(fsEntry.getId(), month);
				log.info("Taking snapshot of mapping and cell codes finished {} {}", year, month);
			} catch (Exception e) {
				log.error("Error while creating the snapshots ", e);
			}
		});
	}

	@Override
	public OemCodeUpdateDto updateOemCode(OemCodeUpdateDto oemCodeUpdateDtos) {
		List<String> codes = TCollectionUtils.transformToList(oemCodeUpdateDtos.getCodes(), OemCodeUpdateDto.CodeUpdate::getCode);
		Map<String, OemCodeUpdateDto.CodeUpdate> codeUpdateMap = TCollectionUtils.transformToMap(oemCodeUpdateDtos.getCodes(),OemCodeUpdateDto.CodeUpdate::getCode);
		List<AccountingOemFsCellCode> accountingOemFsCellCodes = TCollectionUtils.nullSafeList(fsCellCodeRepo.findByCodesAndDealerIdAndOemIdNonDeleted(codes,
				oemCodeUpdateDtos.getYear(),oemCodeUpdateDtos.getOemId().name(), oemCodeUpdateDtos.getCountry()));
		accountingOemFsCellCodes.forEach(a->{
			a.setOemCode(codeUpdateMap.get(a.getCode()).getOemCode());
			a.setDurationType(codeUpdateMap.get(a.getCode()).getDurationType());
			if(Objects.nonNull(codeUpdateMap.get(a.getCode()).getAdditionalInfo())){
				Map<String,String> storedMap = TCollectionUtils.nullSafeMap(a.getAdditionalInfo());
				for(String key: codeUpdateMap.get(a.getCode()).getAdditionalInfo().keySet()){
					storedMap.put(key,codeUpdateMap.get(a.getCode()).getAdditionalInfo().get(key));
				}
				a.setAdditionalInfo(storedMap);
			}
		});
		fsCellCodeRepo.updateBulkOemCode(accountingOemFsCellCodes);
		return oemCodeUpdateDtos;
	}

	@Override
	public void invalidateCache() {
		accountingOemFsCellCodesCache.invalidateAll();
	}


	@Override
	public Map<Integer, Map<String, Set<String>>> getDependentGlAccounts(OEM oem, int year, int version, Set<String> cellCodes, Long tillEpoch) {

		Calendar c = TimeUtils.buildCalendar(tillEpoch);
		int tillMonth = c.get(Calendar.MONTH)+1;
		if(c.get(Calendar.YEAR) != year){
			throw new TBaseRuntimeException(AccountingError.invalidPayload);
		}

		List<AccountingOemFsCellCode> codes = getOemTMappingListFromCache(oem.name(), year, version, dealerConfig.getDealerCountryCode());

		Map<Integer, Map<String, Set<String>>> monthVsCellCodeToAccounts = new HashMap<>();
		Map<String, AccountingOemFsCellCode> cellCodeMap = TCollectionUtils.transformToMap(codes, AccountingOemFsCellCode::getCode);
		Map<String, Set<String>> dependentCellCodesMap = new HashMap<>();
		Map<String, Set<String>> cellCodeVsGroupCodes = new HashMap<>();
		Set<String> groupCodes = new HashSet<>();

		for(String code: new HashSet<>(cellCodes)){
			addDependentCellCodes(code, code, cellCodeMap, groupCodes, cellCodeVsGroupCodes, dependentCellCodesMap);
		}
		Map<Integer, Map<String, Set<String>>> monthVsGCodeToAccounts =
				getGlAccountsForFsCellGroupsFrMonths(oem.name(), year, tillMonth, version, groupCodes);

		for(int month=defaultMonth; month <= tillMonth; month++){
			if(TCollectionUtils.isEmpty(monthVsGCodeToAccounts.get(month))){
				monthVsCellCodeToAccounts.put(month, monthVsCellCodeToAccounts.get(defaultMonth));

			}else{
				Map<String, Set<String>> groupCodeVsGlAccountId = monthVsGCodeToAccounts.get(month);
				Map<String, Set<String>> codeVsGLAccounts = new HashMap<>();

				for(String code: cellCodeVsGroupCodes.keySet()){
					Set<String> finalGlAccountIds = new HashSet<>();
					if(TCollectionUtils.isEmpty(cellCodeVsGroupCodes.get(code))) continue;
					for(String groupCode: cellCodeVsGroupCodes.get(code)){
						Set<String> glAccountIds = groupCodeVsGlAccountId.get(groupCode);
						if(TCollectionUtils.isNotEmpty(glAccountIds)) finalGlAccountIds.addAll(glAccountIds);
					}

					codeVsGLAccounts.computeIfAbsent(code, k -> new HashSet<>()).addAll(finalGlAccountIds);
				}
				monthVsCellCodeToAccounts.put(month, codeVsGLAccounts);
			}
		}

		monthVsCellCodeToAccounts.remove(defaultMonth);

		return monthVsCellCodeToAccounts;
	}

	private void addDependentCellCodes(String parentCode, String childCode, Map<String, AccountingOemFsCellCode> cellCodeMap, Set<String> groupCodes, Map<String
			, Set<String>> cellCodeVsGroupCodes, Map<String, Set<String>> dependentCellCodesMap) {

		if(cellCodeMap.get(childCode) != null ){
			if(dependentCellCodesMap.computeIfAbsent(parentCode, k-> new HashSet<>()).contains(childCode)) return;

			AccountingOemFsCellCode childCellCode = cellCodeMap.get(childCode);

			if(childCellCode.getGroupCode() != null){
				cellCodeVsGroupCodes.computeIfAbsent(parentCode, k -> new HashSet<>()).add(childCellCode.getGroupCode());
				groupCodes.add(childCellCode.getGroupCode());
			}

			dependentCellCodesMap.get(parentCode).add(childCode);

			if(TCollectionUtils.isNotEmpty(childCellCode.getDependentFsCellCodes())){
				for(String x: childCellCode.getDependentFsCellCodes()){
					addDependentCellCodes(parentCode, x, cellCodeMap, groupCodes, cellCodeVsGroupCodes, dependentCellCodesMap);
				}
			}
		}
	}

	private AccountingOemFsCellCode getFsCellCodeFromGroup(AccountingOemFsCellGroup g, OemCellValueType valueType, OemCellDurationType durationType) {
		AccountingOemFsCellCode code = new AccountingOemFsCellCode();
		code.setOemId(g.getOemId());
		code.setDisplayName(g.getGroupDisplayName());
		code.setCode(OemFSUtils.createFsCellCode(g.getGroupCode(), valueType.name(), durationType.name()));
		code.setYear(g.getYear());
		code.setVersion(g.getVersion());
		code.setDerived(false);
		code.setValueType(valueType.name());
		code.setDurationType(durationType.name());
		code.setExpression("");
		code.setDependentFsCellCodes(Lists.newArrayList());
		code.setGroupCode(g.getGroupCode());
		code.setCreatedTime(System.currentTimeMillis());
		code.setModifiedTime(System.currentTimeMillis());
		return code;
	}

	private Map<String, TrialBalanceRow> getTrialBalanceRowForGlAccounts(MonthInfo activeMonthInfo, Integer year, Integer month, boolean includeM13, boolean addM13BalInDecBalances) {

		if (Objects.isNull(month) || Objects.isNull(year)) {
			month = activeMonthInfo.getMonth();
			year = activeMonthInfo.getYear();
		} else {
			month = month - 1;
		}

		TrialBalance trialBalance = accountingService.getTrialBalanceReportForMonthV2(
				year, month, Sets.newHashSet(), false, includeM13, addM13BalInDecBalances);
		return getGlAccountIdToTrialBMap(trialBalance);
	}

	private Map<String, TrialBalanceRow> fetchTrialBalanceRowForGlAccounts(FsReportContext context, FSEntry fsEntry) {
		Map<String, TrialBalanceRow> map;
		if(FSType.CONSOLIDATED.name().equals(fsEntry.getFsType())){
			List<TrialBalanceRow> trialBalanceRows = getTrialBalanceRowForConsolidatedFS(context, fsEntry);
			map =  TCollectionUtils.transformToMap(trialBalanceRows, TrialBalanceRow::getAccountId);
		}
		else {
			map = getGlAccountIdToTrialBMap(accountingService.getCYTrialBalanceTillDayOfMonth(
					context.getTillEpoch(),
					Sets.newConcurrentHashSet(),
					false,
					context.isIncludeM13(),
					DpUtils.doUseTbGeneratorV2VersionForFsInOem(),
					context.isAddM13BalInDecBalances()));
		}

		if(FinancialStatementUtils.isRoundOffGLBalances(context)){
			for(TrialBalanceRow row: map.values()){
				if(Objects.nonNull(row.getOpeningBalance())) row.setOpeningBalance(row.getOpeningBalance().setScale(0, BigDecimal.ROUND_HALF_UP));
				if(Objects.nonNull(row.getCurrentBalance())) row.setCurrentBalance(row.getCurrentBalance().setScale(0, BigDecimal.ROUND_HALF_UP));
				if(Objects.nonNull(row.getDebit())) row.setDebit(row.getDebit().setScale(0, BigDecimal.ROUND_HALF_UP));
				if(Objects.nonNull(row.getCredit())) row.setCredit(row.getCredit().setScale(0, BigDecimal.ROUND_HALF_UP));
			}
		}

		context.setTrialBalanceRowMap(map);

		return map;
	}


	private List<TrialBalanceRow> getTrialBalanceRowForConsolidatedFS(FsReportContext context, FSEntry fsEntry){
		List<String> dealerIds = fsEntry.getDealerIds();
		List<TrialBalanceRow> response = new ArrayList<>();
		Calendar tillEpochInUTC = Calendar.getInstance(TimeZone.getTimeZone("UTC"));
		tillEpochInUTC.setTimeInMillis(context.getTillEpoch());
		context.setTillEpoch(tillEpochInUTC.getTimeInMillis());
		context.setMmddyyyy(TimeUtils.getStringFromEpoch(context.getTillEpoch()));
		List<ConsolidatedFsGlBalanceReportInEpochTask> subTaskList = new ArrayList<>();
		dealerIds.forEach( dealerId -> {
			subTaskList.add(new ConsolidatedFsGlBalanceReportInEpochTask(accountingService, context,
					dealerId, UserContextProvider.getCurrentTenantId(), UserContextProvider.getCurrentUserId()));
		});
		try {
			List<Future<List<TrialBalanceRow>>> futureList =new ArrayList<>();
			subTaskList.stream().forEach( subTask -> {futureList.add(executorService.submit(subTask));});
			for(Future<List<TrialBalanceRow>> future : futureList){
				if(TCollectionUtils.isNotEmpty(future.get())){
//                    log.info("Setting result in final response {}", future.get());
					response.addAll(future.get());
				}
			}
		} catch (InterruptedException | ExecutionException e) {
			log.error("Exception During getting TrialBalanceData");
		}
		return response;
	}

	private Map<String, TrialBalanceRow> getGlAccountIdToTrialBMap(TrialBalance trialBalance) {
		List<TrialBalanceRow> trialBalanceRows = trialBalance.getAccountRows();
		return TCollectionUtils.transformToMap(trialBalanceRows, TrialBalanceRow::getAccountId);
	}

	private Map<String, List<String>> getGlAccountsForFsCellGroups(FsReportContext fsReportContext) {
		Map<String, List<String>> groupCodeVsGlAccountsMap = Maps.newHashMap();

		List<OemFsMappingSnapshot> oemFsMappingSnapshots = oemFsMappingSnapshotRepo
				.findAllSnapshotByYearAndMonth(fsReportContext.getFsId(), fsReportContext.getRequestedMonth(), getCurrentDealerId());

		List<OemFsMapping> oemFsMapping = null;
		if(TCollectionUtils.isEmpty(oemFsMappingSnapshots)){
			oemFsMapping = oemFsMappingRepo
					.getMappings(fsReportContext.getFsId(), getCurrentDealerId());
		}else{
			oemFsMapping = oemFsMappingSnapshots.stream().parallel().map(OemFsMappingSnapshot::toOemMapping).collect(Collectors.toList());
		}

		oemFsMapping.forEach(mapping -> {
			groupCodeVsGlAccountsMap.computeIfAbsent(
					mapping.getFsCellGroupCode(),
					k -> new ArrayList<String>()
			).add(mapping.getGlAccountId());
		});
		return groupCodeVsGlAccountsMap;
	}


	private Map<Integer, Map<String, Set<String>>>
	getGlAccountsForFsCellGroupsFrMonths(String oem, int year, int lastMonth, int version, Set<String> groupCodes) {

		FSEntry fsEntry = fsEntryRepo.findDefaultType(oem, year, UserContextProvider.getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		List<OemFsMappingSnapshot> oemFsMappingSnapshots = oemFsMappingSnapshotRepo
				.findAllSnapshotsUntilMonth(fsEntry.getId(), lastMonth, groupCodes, getCurrentDealerId());

		Map<Integer, List<OemFsMappingSnapshot>> snapshotsByMonth = oemFsMappingSnapshots.stream().collect(Collectors.groupingBy(OemFsMappingSnapshot::getMonth));

		Map<Integer, Map<String, Set<String>>> monthVsCodeVsAccounts = new HashMap<>();

		boolean someMappingsAreEmpty = false;

		for(int i=Calendar.JANUARY+1; i<=lastMonth; i++){
			if(TCollectionUtils.isEmpty(snapshotsByMonth.get(i))){
				someMappingsAreEmpty = true;
				break;
			}
		}

		Map<String, Set<String>> groupCodeVsGlAccountsMap = Maps.newHashMap();

		if(someMappingsAreEmpty){
			List<OemFsMapping> oemFsMapping;
			oemFsMapping = oemFsMappingRepo
					.getMappingsByGroupCodes(getCurrentDealerId(), year, 1, oem, groupCodes, UserContextUtils.getSiteIdFromUserContext() );

			if(TCollectionUtils.isNotEmpty(oemFsMapping)){
				oemFsMapping.forEach(mapping -> {
					groupCodeVsGlAccountsMap.computeIfAbsent(
							mapping.getFsCellGroupCode(), k -> new HashSet<>()).add(mapping.getGlAccountId()
					);
				});
			}
		}

		for(int i=Calendar.JANUARY+1; i<=lastMonth; i++){
			if(TCollectionUtils.isNotEmpty(snapshotsByMonth.get(i))){
				Map<String, Set<String>> groupCodeVsGlAccountsMap2 = Maps.newHashMap();
				snapshotsByMonth.get(i).forEach(mapping -> {
					groupCodeVsGlAccountsMap2.computeIfAbsent(
							mapping.getFsCellGroupCode(), k -> new HashSet<>()).add(mapping.getGlAccountId()
					);
				});
				monthVsCodeVsAccounts.put(i, groupCodeVsGlAccountsMap2);
			}else{
				monthVsCodeVsAccounts.put(defaultMonth, groupCodeVsGlAccountsMap);
			}
		}

		return monthVsCodeVsAccounts;
	}

	private void computeDerivedCellValue(OemFsCellContext context) {
		AccountingOemFsCellCode fsCellCode = context.getFsCellCode();

		if(Objects.isNull(fsCellCode)){
			return ;
		}

		if (OemCellSubType.MONTHLY.name().equalsIgnoreCase(fsCellCode.getSubType())
				&& (Integer.parseInt(fsCellCode.getAdditionalInfo().get(additionInfoField_month)) != context.getRequestedMonth())) {
			return;
		}

		for(String code : fsCellCode.getDependentFsCellCodes()){
			if(context.getCodeVsDetailsMap().containsKey(code)){
				continue;
			}
			context.setFsCellCode(context.getCodeVsCellInfoMap().get(code));
			computeDerivedCellValue(context);
			context.setFsCellCode(fsCellCode);
		}

		String finalExpression = OemFSUtils.getExpressionReplacedByValues(context.getFsCellCode().getExpression(), context.getCodeVsValueMap());

		BigDecimal calculatedAmount = getValueWithPrecision(OemFSUtils.getCalculatedAmount(finalExpression), context);

		context.getCodeVsDetailsMap().put(fsCellCode.getCode(),
				FsCodeDetail.builder()
						.value(calculatedAmount)
						.derived(true)
						.dependentFsCellCodes(fsCellCode.getDependentFsCellCodes())
						.build());
		context.getCodeVsValueMap().put(fsCellCode.getCode(), calculatedAmount);
	}

	private void computeMonthlyExpressions(OemFsCellContext context) {
		AccountingOemFsCellCode fsCellCode = context.getFsCellCode();

		if(Objects.isNull(fsCellCode)){
			return ;
		}

		for(String code : fsCellCode.getDependentFsCellCodes()){
			if(context.getCodeVsDetailsMap().containsKey(code)){
				continue;
			}
			context.setFsCellCode(context.getCodeVsCellInfoMap().get(code));
			computeDerivedCellValue(context);
			context.setFsCellCode(fsCellCode);
		}

		String newExpression = OemFSUtils.getExpressionReplacedByExpression(context.getCodeVsExpressionMap()
				.get(context.getFsCellCode().getCode()), context.getCodeVsExpressionMap());

		context.getCodeVsExpressionMap().put(context.getFsCellCode().getCode(), newExpression);

		if(OemCellSubType.MONTHLY.name().equalsIgnoreCase(context.getFsCellCode().getSubType())){
			context.getCodeIdentifierVsExpressionMap().put(context.getFsCellCode().getAdditionalInfo().get(additionInfoField_codeIdentifier), newExpression);
		}
	}

	private FsCodeDetail computeNonDerivedCellValue(OemFsCellContext oemFsCellContext) {
		AccountingOemFsCellCode fsCellCode = oemFsCellContext.getFsCellCode();
		BigDecimal cellValue = BigDecimal.ZERO;
		List<OemGlAccountDetail> glAccountDetails = Lists.newArrayList();

		for (String glAccountId : oemFsCellContext.getGroupCodeVsGlAccountsMap().get(fsCellCode.getGroupCode())) {
			BigDecimal glAccountValue = BigDecimal.ZERO;
			TrialBalanceRow trialBalanceRow = oemFsCellContext.getTrialBalanceRowMap().get(glAccountId);

			if(OemCellValueType.BALANCE.name().equals(fsCellCode.getValueType())){
				if(OemCellDurationType.MTD.name().equalsIgnoreCase(fsCellCode.getDurationType())){
					glAccountValue = getMtdBalance(trialBalanceRow);
				}else{
					glAccountValue = getYtdBalance(trialBalanceRow);
				}
			}else{
				if(OemCellDurationType.MTD.name().equalsIgnoreCase(fsCellCode.getDurationType())){
					glAccountValue = getMtdCount(trialBalanceRow);
				}else{
					glAccountValue = getYtdCount(trialBalanceRow);
				}
			}
			cellValue = cellValue.add(glAccountValue);
			OemGlAccountDetail oemGlAccountDetail = OemGlAccountDetail.builder()
					.glAccountId(glAccountId)
					.value(glAccountValue)
					.build();
			glAccountDetails.add(oemGlAccountDetail);
		}
		FsCodeDetail fsCodeDetail = new FsCodeDetail();
		fsCodeDetail.setValue(getValueWithPrecision(cellValue, oemFsCellContext));
		fsCodeDetail.setGlAccountDetails(glAccountDetails);
		return fsCodeDetail;
	}

	@Override
	public AccountingOemFsCellCode saveFsCellCode(FSCellCodeCreateDto reqDto) {

		AccountingOemFsCellCode fsCellCodeInDb = fsCellCodeRepo.findByCodeOemIdYearAndCountry(reqDto.getCode(), reqDto.getYear(), reqDto.getOemId().name(), reqDto.getCountry());
		if(Objects.isNull(fsCellCodeInDb)){
			return fsCellCodeRepo.save(reqDto.toFsCellCode());
		}else{
			reqDto.applyFieldsToExistingFsCellCode(fsCellCodeInDb);
			return fsCellCodeRepo.save(fsCellCodeInDb);
		}
	}

	@Override
	public void populateGroupCodesInFsCell(OEM oem, int year, int version) {
		List<AccountingOemFsCellGroup> groups = oemFsCellGroupRepo.findNonDeletedByOemIdYearVersionAndCountry(oem.name(),year,version, dealerConfig.getDealerCountryCode());
		List<AccountingOemFsCellCode> codes = Lists.newArrayList();
		groups.forEach(g->{
			List<String> fsCellCodes = Lists.newArrayList(OemFSUtils.createFsCellCode(g.getGroupCode(), OemCellValueType.BALANCE.name(), OemCellDurationType.MTD.name()),
					OemFSUtils.createFsCellCode(g.getGroupCode(), OemCellValueType.BALANCE.name(), OemCellDurationType.YTD.name()),
					OemFSUtils.createFsCellCode(g.getGroupCode(), OemCellValueType.COUNT.name(), OemCellDurationType.MTD.name()),
					OemFSUtils.createFsCellCode(g.getGroupCode(), OemCellValueType.COUNT.name(), OemCellDurationType.YTD.name()));
			List<AccountingOemFsCellCode> accountingOemFsCellCodes = fsCellCodeRepo.findByCodesAndDealerIdAndOemIdNonDeleted(fsCellCodes,year,oem.name(), dealerConfig.getDealerCountryCode());
			TCollectionUtils.nullSafeList(accountingOemFsCellCodes).forEach(t->{
				t.setGroupCode(g.getGroupCode());
				t.setSource(g.getSource());
			});
			codes.addAll(TCollectionUtils.nullSafeList(accountingOemFsCellCodes));
		});
		fsCellCodeRepo.updateBulk(codes);
	}

	@Override
	public List<AccountingOemFsCellCode> deleteCellCodes(FsCellCodeDeleteDto dto){

		List<AccountingOemFsCellCode> cellCodesToDelete = fsCellCodeRepo
				.findByCodesAndDealerIdAndOemIdNonDeleted(
						dto.getCellCodes().stream().distinct().collect(Collectors.toList()), dto.getYear(), dto.getOemId().name(), dto.getCountry()
				);

		cellCodesToDelete.forEach(x -> x.setDeleted(true));

		fsCellCodeRepo.delete(cellCodesToDelete);
		return cellCodesToDelete;
	}

	@Override
	public List<OemFsMapping> deleteMemoFSMappings(String oem, int year, int version){

		String dealerId = getCurrentDealerId();
		List<OemFsMapping> allMappings = oemFsMappingRepo
				.findNonDeletedMappingsForOEMYearVersionByDealerIdAndSite(oem, year, version, dealerId,UserContextUtils.getSiteIdFromUserContext());
		if(TCollectionUtils.isEmpty(allMappings)){
			return allMappings;
		}

		//TODO: check
		List<GLAccount> glAccounts = accountingService.getGLAccounts(dealerId).stream().filter(x -> (allMappings.stream().map(OemFsMapping::getGlAccountId).collect(Collectors.toList()).contains(x.getId()))).collect(Collectors.toList());
		Set<String> memoIds = glAccounts.stream()
				.filter(e -> e.getAccountTypeId().equals(AccountType.MEMO.name()))
				.map(GLAccount::getId).collect(Collectors.toSet());
		List<OemFsMapping> memoMappings = allMappings.stream()
				.filter(e -> memoIds.contains(e.getGlAccountId())).collect(Collectors.toList());
		oemFsMappingRepo.delete(oem, year, version, memoMappings, dealerId, UserContextUtils.getSiteIdFromUserContext());
		memoMappings.forEach(e -> e.setDeleted(true));

		return memoMappings;
	}

	@Override
	public List<OemFsMapping> deleteFSMappings(FSMappingDeleteDto dto){
		if(StringUtils.isBlank(dto.getSiteId())){
			dto.setSiteId(UserContextUtils.getSiteIdFromUserContext());
		}
		String dealerId = getCurrentDealerId();
		List<String> groupCodes = dto.getGroupDisplayNames().stream().map(OemFSUtils::createGroupCode).collect(Collectors.toList());
		List<OemFsMapping> mappingsToDelete = oemFsMappingRepo
				.findMappingByGroupCodes(dto.getOemId().name(), dto.getYear(), dto.getVersion(), dealerId, groupCodes,dto.getSiteId() );
		oemFsMappingRepo.delete(dto.getOemId().name(), dto.getYear(), dto.getVersion(), mappingsToDelete, dealerId, dto.getSiteId());
		mappingsToDelete.forEach(e -> e.setDeleted(true));

		return mappingsToDelete;
	}

	@Override
	public List<AccountingOemFsCellCode> migrateCellCodesToYear(String oemId, int fromYear, int toYear, String country){

		List<AccountingOemFsCellCode> cellCodes1 = fsCellCodeRepo.getFsCellCodesForOemYearAndCountry(oemId, toYear, 1, country);
		if(TCollectionUtils.isNotEmpty(cellCodes1)){
			throw new TBaseRuntimeException(AccountingError.valuesExistForRequestedYear);
		}

		List<AccountingOemFsCellCode> cellCodes = fsCellCodeRepo.getFsCellCodesForOemYearAndCountry(oemId, fromYear, 1, country);

		if(TCollectionUtils.isEmpty(cellCodes)) return new ArrayList<>();

		for(AccountingOemFsCellCode code: cellCodes){
			code.setId(new ObjectId().toHexString());
			code.setCreatedTime(System.currentTimeMillis());
			code.setModifiedTime(System.currentTimeMillis());
			code.setYear(toYear);
		}
		fsCellCodeRepo.insertBulk(cellCodes);

		return fsCellCodeRepo.getFsCellCodesForOemYearAndCountry(oemId, toYear, 1, country);
	}

	@Override
	public List<AccountingOemFsCellGroup> migrateGroupsCodesToYear(String oemId, int fromYear, int toYear){
		List<AccountingOemFsCellGroup> groupCodes1 = oemFsCellGroupRepo.findByOemId(oemId, toYear, dealerConfig.getDealerCountryCode());

		if(TCollectionUtils.isNotEmpty(groupCodes1)){
			throw new TBaseRuntimeException(AccountingError.valuesExistForRequestedYear);
		}

		List<AccountingOemFsCellGroup> groupCodes = oemFsCellGroupRepo.findByOemId(oemId, fromYear, dealerConfig.getDealerCountryCode());

		if(TCollectionUtils.isEmpty(groupCodes)) return new ArrayList<>();

		for(AccountingOemFsCellGroup group: groupCodes){
			group.setId(new ObjectId().toHexString());
			group.setCreatedTime(System.currentTimeMillis());
			group.setModifiedTime(System.currentTimeMillis());
			group.setYear(toYear);
		}
		oemFsCellGroupRepo.insertBulk(groupCodes);

		return oemFsCellGroupRepo.findByOemId(oemId, toYear, dealerConfig.getDealerCountryCode());
	}

	@Override
	public List<OemFsMapping> migrateMappingsToYear(String oemId, int fromYear, int toYear, int version){
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, toYear, getCurrentDealerId(),UserContextUtils.getSiteIdFromUserContext());
		FSEntry fsEntry1 = fsEntryRepo.findDefaultType(oemId, fromYear, getCurrentDealerId(),UserContextUtils.getSiteIdFromUserContext());

		String fsId1 = fsEntry.getOemId();
		String fsId2 = fsEntry1.getOemId();

		List<OemFsMapping> mappings1 = oemFsMappingRepo.findMappingsByFsId(fsId1, getCurrentDealerId());

		if(TCollectionUtils.isNotEmpty(mappings1)){
			throw new TBaseRuntimeException(AccountingError.valuesExistForRequestedYear);
		}

		List<OemFsMapping> mappings = oemFsMappingRepo.findMappingsByFsId(fsId2, getCurrentDealerId());

		if(TCollectionUtils.isEmpty(mappings)) return new ArrayList<>();
		for(OemFsMapping mapping: mappings){
			mapping.setYear(toYear);
			mapping.setId(new ObjectId().toHexString());
			mapping.setCreatedByUserId(UserContextProvider.getCurrentUserId());
			mapping.setCreatedTime(System.currentTimeMillis());
			mapping.setModifiedTime(System.currentTimeMillis());
		}
		oemFsMappingRepo.insertBulk(mappings);

		return oemFsMappingRepo
				.findMappingsByFsId(fsId1, getCurrentDealerId());
	}

	@Override
	public void createSnapshotsForMapping(MappingSnapshotDto dto){
		FSEntry fsEntry = fsEntryRepo.findByIdAndDealerIdWithNullCheck(dto.getFsId(), UserContextProvider.getCurrentDealerId());
		List<OemFsMappingSnapshot> fsMappingSnapshots = Lists.newArrayList();

		if(Objects.nonNull(oemFsMappingSnapshotRepo.findOneSnapshot(dto.getFsId(), dto.getSnapshotMonths(), getCurrentDealerId()))) {
			throw new TBaseRuntimeException("Snapshots already exists for one or more requested months!");
		}

		List<OemFsMapping> currentOemMappings = oemFsMappingRepo.findMappingsByFsId(dto.getFsId(), getCurrentDealerId());

		for(int sMonth: dto.getSnapshotMonths()){
			currentOemMappings.forEach(oemFsMapping -> {
				OemFsMappingSnapshot snapshot = oemFsMapping.toSnapshot();
				snapshot.setMonth(sMonth);
				snapshot.setYear(dto.getSnapshotYear());
				snapshot.setFsId(dto.getFsId());
				fsMappingSnapshots.add(snapshot);
			});
		}

		log.info("{} OemFsMapping snapshots created", fsMappingSnapshots.size());
		oemFsMappingSnapshotRepo.saveBulkSnapshot(fsMappingSnapshots);
	}

	@Override
	public void deleteMappingSnapshots(MappingSnapshotDto dto){
		oemFsMappingSnapshotRepo.deleteSnapshots(dto.getFsId(), dto.getSnapshotMonths(), getCurrentDealerId());
	}

	@Override
	public List<AccountingOemFsCellGroup> deleteGroupCodes(String oemId, int year, List<String> groupDisplayNames, int version, String country){
		List<AccountingOemFsCellGroup> cellGroups = oemFsCellGroupRepo.findNonDeletedByOemIdYearVersionAndCountry(oemId, year, version, country);
		List<AccountingOemFsCellGroup> codesToRemove = cellGroups.stream().filter(x -> groupDisplayNames.contains(x.getGroupDisplayName())).collect(Collectors.toList());
		oemFsCellGroupRepo.delete(codesToRemove);
		return codesToRemove;
	}

	/**
	 * Creates Mapping if GLAccountNo and CellGroup Display Name is name
	 * */
	@Override
	public List<OemFsMapping> createMappingsFromGlAccounts(String oemId, Integer year, Integer version, String country){
		List<AccountingOemFsCellGroup> cellGroups = oemFsCellGroupRepo.findNonDeletedByOemIdYearVersionAndCountry(oemId, year, version, country);
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, year, getCurrentDealerId(), UserContextUtils.getSiteIdFromUserContext());
		List<OemFsMapping> mappingsInDb = oemFsMappingRepo.findMappingsByFsId(fsEntry.getId(), UserContextProvider.getCurrentDealerId());
		List<String> cellCodes = mappingsInDb.stream().map(OemFsMapping::getFsCellGroupCode).collect(Collectors.toList());
		List<String> groupDisplayNames = cellGroups.stream().filter(x -> !cellCodes.contains(x.getGroupCode()))
				.map(AccountingOemFsCellGroup::getGroupDisplayName).collect(Collectors.toList());
		List<GLAccount> glAccounts = accountingService.getGLAccounts(UserContextProvider.getCurrentDealerId()).stream().filter(x -> (groupDisplayNames).contains(x.getAccountName())).collect(Collectors.toList());
		//List<GLAccount> glAccounts = glAccountRepository.findByAccountNosAndDealerId(groupDisplayNames);
		List<OemFsMapping> mappingsToCreate = new ArrayList<>();
		glAccounts.forEach(x -> {
			OemFsMapping m  = OemFsMapping.builder().fsCellGroupCode(OemFSUtils.createGroupCode(x.getAccountNumber())).glAccountId(x.getId())
					.createdByUserId(UserContextProvider.getCurrentUserId()).dealerId(UserContextProvider.getCurrentDealerId()).oemId(oemId)
					.version(version).year(year).build();
			mappingsToCreate.add(m);
		});
		oemFsMappingRepo.insertBulk(mappingsToCreate);
		return mappingsToCreate;
	}


	private BigDecimal getYtdBalance(TrialBalanceRow trialBalanceRow) {
		if(Objects.nonNull(trialBalanceRow)) {
			return trialBalanceRow.getCurrentBalance();
		}else {
			return BigDecimal.ZERO;
		}
	}

	private BigDecimal getMtdBalance(TrialBalanceRow trialBalanceRow) {
		if(Objects.nonNull(trialBalanceRow)) {
			return trialBalanceRow.getDebit().subtract(trialBalanceRow.getCredit());
		}else{
			return BigDecimal.ZERO;
		}
	}

	private BigDecimal getYtdCount(TrialBalanceRow trialBalanceRow) {
		if(Objects.nonNull(trialBalanceRow)) {
			return BigDecimal.valueOf(trialBalanceRow.getYtdCount());
		}else {
			return BigDecimal.ZERO;
		}
	}

	private BigDecimal getMtdCount(TrialBalanceRow trialBalanceRow) {
		if(Objects.nonNull(trialBalanceRow)) {
			return BigDecimal.valueOf(trialBalanceRow.getCount());
		}else{
			return BigDecimal.ZERO;
		}
	}

//    @Override
//    public List<OEMFinancialMapping> saveMappingsForGl(String glAccountId, List<OEMFinancialMapping> mappings) {
//        TPreConditions.notBlank(glAccountId, "oemMapping.glAccountId.cant.be.null");
//        List<OEMFinancialMapping> mappingsToDelete = Lists.newArrayList();
//        List<OEMFinancialMapping> upsertList = Lists.newArrayList();
//
//        for(OEMFinancialMapping m : TCollectionUtils.nullSafeList(mappings)){
//            if(m.getOemAccountNumber() == null) {
//                if (m.getId() != null) {
//                    mappingsToDelete.add(m);
//                }
//            } else {
//                upsertList.add(mappingToSave(m, glAccountId));
//            }
//        }
//
//        if(TCollectionUtils.isNotEmpty(mappingsToDelete)){
//            oemFSMappingRepo.deleteMappings(mappingsToDelete);
//        }
//
//        if(TCollectionUtils.isNotEmpty(upsertList)) {
//            oemFSMappingRepo.upsertMappings(upsertList);
//        }
//
//        return upsertList;
//    }

//    private OEMFinancialMapping mappingToSave(OEMFinancialMapping mapping, String glAccountId){
//        if(mapping.getId() == null){
//            mapping.setId(UUID.randomUUID().toString());
//            mapping.setDealerId(UserContextProvider.getCurrentDealerId());
//            mapping.setCreatedTime(System.currentTimeMillis());
//        }
//        mapping.setGlAccountId(glAccountId);
//        mapping.setModifiedTime(System.currentTimeMillis());
//        return mapping;
//    }

	private OEMFinancialMapping fromDto(OEMMappingDto dto, OemMappingRequestDto mappingRequest){
		OEMFinancialMapping mapping = OEMFinancialMapping.builder()
				.glAccountId(dto.getGlAccountId())
				.glAccountDealerId(dto.getGlAccountDealerId())
				.oemAccountNumber(dto.getOemAccountNumber())
				.fsId(mappingRequest.getFsId())
				.dealerId(getCurrentDealerId())
				.build();

		String id = dto.getId();
		if(id == null){
			id = UUID.randomUUID().toString();
		}

		mapping.setId(id);
		return  mapping;
	}

	private FsCodeDetail computeNonDerivedForMemo(OemFsCellContext oemFsCellContext) {
		BigDecimal value = BigDecimal.ZERO;
		String stringValue = null;
		String memoKey = oemFsCellContext.getFsCellCode().getAdditionalInfo().get("memoKey");
		if(TStringUtils.isNotBlank(memoKey)){
			MemoWorksheet memoWorksheet = oemFsCellContext.getMemoKeyToValueMap().get(memoKey);
			if(Objects.nonNull(memoWorksheet)){
				MemoValue memoValue = memoWorksheet.getValues().get(oemFsCellContext.getRequestedMonth() - 1);
				if(OemCellValueType.DATE.name().equals(oemFsCellContext.getFsCellCode().getValueType())){
					stringValue = TimeUtils.getStringFromEpoch(memoValue.getMtdValue().longValue(), "MMddyyyy");
					value = memoValue.getMtdValue();
				}else if(OemCellDurationType.YTD.name().equalsIgnoreCase(oemFsCellContext.getFsCellCode().getDurationType())){
					value = memoValue.getYtdValue();
				}else{
					value = memoValue.getMtdValue();
				}
			}
		}

		return  FsCodeDetail.builder()
				.stringValue(stringValue)
				.value(getValueWithPrecision(value, oemFsCellContext))
				.derived(false)
				.build();
	}

	private FsCodeDetail computeNonDerivedForHC(OemFsCellContext oemFsCellContext) {
		BigDecimal value = BigDecimal.ZERO;
		String department = oemFsCellContext.getFsCellCode().getAdditionalInfo().get("department");
		String position = oemFsCellContext.getFsCellCode().getAdditionalInfo().get("position");
		if(TStringUtils.isNotBlank(department) && TStringUtils.isNotBlank(position)){
			String hcKey = department+"_"+position;
			if(TStringUtils.isNotBlank(hcKey)){
				HCWorksheet hcWorksheet = oemFsCellContext.getHcKeyValueMap().get(hcKey);
				if(Objects.nonNull(hcWorksheet)){
					value = hcWorksheet.getValues().get(oemFsCellContext.getRequestedMonth() - 1).getValue();
				}
			}
		}

		return  FsCodeDetail.builder()
				.value(getValueWithPrecision(value, oemFsCellContext))
				.derived(false)
				.build();
	}

	private YearMonth getFYStartDetails(int requestedYear, int requestedMonth, int fiscalStartMonth){

		log.info("requestedYear {} reqMonth {} FYStartMonth {}", requestedYear, requestedMonth, fiscalStartMonth);

		int fiscalStartYear = requestedYear;

		if(requestedMonth < fiscalStartMonth){
			fiscalStartYear = fiscalStartYear-1;
		}

		return YearMonth.of(fiscalStartYear, Month.of(fiscalStartMonth+1));
	}

	private void updateMemoWorksheetsByFY(List<MemoWorksheet> sheets, FsReportContext fsReportContext) {

		//log.info("actual memoSheets {}", JsonUtil.toJson(sheets));

		if(sheets.size() <= 0 || FieldType.LABOR_RATE.name().equals(sheets.get(0).getFieldType())
				|| FieldType.PERCENTAGE.name().equals(sheets.get(0).getFieldType())) return;

		MemoWorksheet reqYearMemo = sheets.get(0);

		if(sheets.size() > 1 && sheets.get(1).getYear() == fsReportContext.getRequestedYear()) reqYearMemo = sheets.get(1);

		MemoValue[] memoValues = new MemoValue[24];

		int fromYear = fsReportContext.getFromYear();
		int fromMonth = fsReportContext.getFromMonth();

		for(MemoWorksheet memoSheet: sheets){
			if(fromYear == memoSheet.getYear()){
				for(MemoValue val: memoSheet.getValues()){
					memoValues[val.getMonth()-1] = val;
				}
			}else{
				for(MemoValue val: memoSheet.getValues()){
					memoValues[11 + val.getMonth()] = val;
				}
			}
		}

		for(int i=0; i<24; i++){
			if(memoValues[i] == null){
				memoValues[i] = new MemoValue(i%12, BigDecimal.ZERO, BigDecimal.ZERO);
			}
		}

		int curPos = fromMonth - 1;

		Calendar c = Calendar.getInstance();

		c.set(Calendar.MONTH, fromMonth-1);

		BigDecimal currentYtd = BigDecimal.ZERO;

		MemoValue[] fyMemoValues = new MemoValue[12];

		while(true){

			currentYtd = currentYtd.add(memoValues[curPos].getMtdValue());
			memoValues[curPos].setYtdValue(currentYtd);
			fyMemoValues[curPos%12] = memoValues[curPos];

			if(c.get(Calendar.MONTH) == fsReportContext.getRequestedMonth() - 1){
				break;
			}

			c.roll(Calendar.MONTH, 1);
			curPos += 1;
		}


		for(int i= 0; i < 12; i++){
			if(fyMemoValues[i] == null){
				fyMemoValues[i] =  new MemoValue(i, BigDecimal.ZERO, BigDecimal.ZERO);
			}
		}

		reqYearMemo.setValues(Arrays.asList(fyMemoValues));
		//log.info("updated fyMemoValues {}", JsonUtil.toJson(fyMemoValues));
	}

	private String getDefaultPrecision(String oemId, OemConfig oemConfig){
		if(Objects.isNull(oemConfig)) return null;

		return oemConfig.getDefaultPrecision();
	}

	private boolean getRoundOffProperty(OemConfig oemConfig) {
		String globalPref = dealerRoundOffPref.getSafeGlobalValue(DEFAULT_ROUND_OFF);
		String dealerPref = dealerRoundOffPref.getSafeValueWithUserContext(DEFAULT_ROUND_OFF);
		boolean oemPref = oemConfig.isEnableRoundOff();

		log.info("dealer property loaded {}", dealerRoundOffPref.isPropertyLoadedWithUserContext());
		log.info("global property loaded {}", dealerRoundOffPref.isGlobalPropertyLoaded());

		log.info(" dealer prop value: {} tenant Id {} dealerId {}", dealerPref, getCurrentTenantId(), getCurrentDealerId());
		log.info("global prop val: {}", globalPref);

		if (oemPref || ENABLE_ROUND_OFF.equals(dealerPref) || (DEFAULT_ROUND_OFF.equals(dealerPref) && ENABLE_ROUND_OFF.equals(globalPref))) {
			log.info("Using round off for FS generation");
			return true;
		}

		return false;
	}

	private BigDecimal getValueWithPrecision(BigDecimal value, OemFsCellContext oemFsCellContext) {

		if(!oemFsCellContext.isRoundOff()) return value;

		String prec = null;

		if(oemFsCellContext.getDefaultPrecision() != null && !oemFsCellContext.getDefaultPrecision().isEmpty()){
			prec = oemFsCellContext.getDefaultPrecision();
		}

		if(TCollectionUtils.isNotEmpty(oemFsCellContext.getFsCellCode().getAdditionalInfo())){
			String cellCodePrecision = oemFsCellContext.getFsCellCode().getAdditionalInfo().get(TConstants.PRECISION);

			if(cellCodePrecision != null && !cellCodePrecision.isEmpty()){
				prec = oemFsCellContext.getFsCellCode().getAdditionalInfo().get(TConstants.PRECISION);
			}
		}

		if(Objects.isNull(prec)) return value;

		try{
			int precision = Integer.parseInt(prec);
			value = value.setScale(precision, BigDecimal.ROUND_HALF_UP);
		}catch (NumberFormatException ignored){}

		return value;
	}

	// Api is for developer use only
	@Override
	public List<OemFsMappingSimilarToUI> internalExportApiForOemMapping(String oemId, Integer year, Integer version, Integer month, boolean includeM13, boolean addM13BalInDecBalances){
		FSEntry fsEntry = fsEntryRepo.findDefaultType(oemId, year, getCurrentDealerId(),UserContextUtils.getSiteIdFromUserContext());
		List<OemFsMappingSimilarToUI> oemFsMappingSimilarToUIList = new ArrayList<>();
		Map<String,GLAccount> idGLAccountMap = accountingService.getGLAccounts(UserContextProvider.getCurrentDealerId()).stream().filter(e -> !AccountType.MEMO.name().equals(e.getAccountTypeId()) &&
				!AccountType.EXPENSE_ALLOCATION.name().equals(e.getAccountTypeId())).collect(Collectors.toMap(GLAccount::getId, a -> a));
		Map<String,List<String>> glIdOemFsMappingsMap = new HashMap<>();
		Map<String,String> oemFsGroupCodeMap = TCollectionUtils.nullSafeList(oemFsCellGroupRepo.findNonDeletedByOemIdYearVersionAndCountry(oemId, year, version, dealerConfig.getDealerCountryCode()))
				.stream().collect(Collectors.toMap(AccountingOemFsCellGroup::getGroupCode, AccountingOemFsCellGroup::getGroupDisplayName));
		List<OemFsMapping> oemFsMappingList = oemFsMappingRepo.findMappingsByFsId(fsEntry.getId(), getCurrentDealerId());
		for(OemFsMapping oemFsMapping : oemFsMappingList){
			String groupDisplayName = oemFsGroupCodeMap.get(oemFsMapping.getFsCellGroupCode());
			if(glIdOemFsMappingsMap.containsKey(oemFsMapping.getGlAccountId())){
				List<String> mappedGroupCodes = new ArrayList<>(glIdOemFsMappingsMap.get(oemFsMapping.getGlAccountId()));
				mappedGroupCodes.add(groupDisplayName);
				glIdOemFsMappingsMap.put(oemFsMapping.getGlAccountId(), mappedGroupCodes);
			} else{
				glIdOemFsMappingsMap.put(oemFsMapping.getGlAccountId(), Lists.newArrayList(groupDisplayName));
			}
		}
		Map<CustomFieldType, Map<String, OptionMinimal>> keyToIdToOptionMap = customFieldConfig.getKeyToIdToOptionMap();
		MonthInfo activeMonthInfo = getActiveMonthInfo();
		FsReportContext fsReportContext = new FsReportContext();
		fsReportContext.setActiveMonthInfo(activeMonthInfo);
		fsReportContext.setRequestedYear(year);
		fsReportContext.setRequestedMonth(month);
		fsReportContext.setIncludeM13(includeM13);
		fsReportContext.setAddM13BalInDecBalances(addM13BalInDecBalances);
		Map<String, TrialBalanceRow> trialBalanceRowMap = fetchTrialBalanceRowForGlAccounts(fsReportContext, fsEntry);
		for(Map.Entry<String,GLAccount> glAccountEntry : idGLAccountMap.entrySet()){
			String glAccountId = glAccountEntry.getKey();
			OemFsMappingSimilarToUI oemFsMappingSimilarToUI = new OemFsMappingSimilarToUI();
			oemFsMappingSimilarToUI.toOemFsMappingBean(trialBalanceRowMap.get(glAccountId),glAccountEntry.getValue(),glIdOemFsMappingsMap);
			oemFsMappingSimilarToUI.resolveDepartmentFromId(glAccountEntry.getValue(), keyToIdToOptionMap);
			oemFsMappingSimilarToUIList.add(oemFsMappingSimilarToUI);
		}
		return oemFsMappingSimilarToUIList;
	}

	public List<FSEntry> updateSiteIdInOemMappings(List<OemFsMappingSiteIdChangesReqDto> reqDtos){
		if(TCollectionUtils.isEmpty(reqDtos)){
			log.info("request Dto is empty");
			return null;
		}
		List<FSEntry> fsEntries = Lists.newArrayList();
		for(OemFsMappingSiteIdChangesReqDto reqDto : reqDtos){
			if(TStringUtils.isBlank(reqDto.getSiteId())){
				log.info("siteId should not be empty");
				continue;
			}
			List<OemFsMapping> oemFsMappings = oemFsMappingRepo.findMappingsForOEMYearVersionByDealerIdNonDeleted(reqDto.getOemId(), reqDto.getYear(), reqDto.getVersion(), getCurrentDealerId());
			FSEntry fsEntry = fsEntryRepo.findByOemYearVersion(reqDto.getOemId(),reqDto.getYear(),reqDto.getVersion(),UserContextProvider.getCurrentDealerId());
			List<MemoWorksheet> memoWorksheetList = memoWorksheetRepo.findForOemByYearOemIdVersion(reqDto.getOemId(), reqDto.getYear(), reqDto.getVersion());
			List<HCWorksheet> hcWorksheets = hcWorksheetRepo.findByOemIdYearVersion(reqDto.getOemId(), reqDto.getYear(), reqDto.getVersion());
			List<OEMFsCellCodeSnapshot> oemFsCellCodeSnapshots = oemFsCellCodeSnapshotRepo.findAllSnapshotByYearOemIdVersion(reqDto.getOemId(), reqDto.getYear(), reqDto.getVersion(), UserContextProvider.getCurrentDealerId());
			List<OemFsMappingSnapshot> oemFsMappingSnapshots = oemFsMappingSnapshotRepo.findAllSnapshotsByYearVersionOemId(reqDto.getOemId(), reqDto.getVersion(),reqDto.getYear());

			fsEntry.setSiteId(reqDto.getSiteId());
			oemFsMappings.forEach(oemFsMapping -> { oemFsMapping.setSiteId(reqDto.getSiteId()); });
			memoWorksheetList.forEach(memoWorksheet -> { memoWorksheet.setSiteId(reqDto.getSiteId()); });
			hcWorksheets.forEach(hcWorksheet -> { hcWorksheet.setSiteId(reqDto.getSiteId()); });
			oemFsCellCodeSnapshots.forEach(oemFsCellCodeSnapshot -> { oemFsCellCodeSnapshot.setSiteId(reqDto.getSiteId()); });
			oemFsMappingSnapshots.forEach(oemFsMappingSnapshot -> { oemFsMappingSnapshot.setSiteId(reqDto.getSiteId()); });


			fsEntries.add(fsEntry);
			oemFsMappingRepo.updateBulk(oemFsMappings);
			fsEntryRepo.save(fsEntry);
			memoWorksheetRepo.updateBulk(memoWorksheetList,UserContextProvider.getCurrentDealerId());
			hcWorksheetRepo.updateBulk(hcWorksheets,UserContextProvider.getCurrentDealerId());
			oemFsCellCodeSnapshotRepo.updateSiteIdInBulk(oemFsCellCodeSnapshots,UserContextProvider.getCurrentDealerId());
			oemFsMappingSnapshotRepo.updateSiteIdInBulk(oemFsMappingSnapshots,UserContextProvider.getCurrentDealerId());

		}
		return fsEntries;
	}

	@Override
	public void migrateOemFsMappingFromOemToFSLevel(String dealerId) {
		List<FSEntry> fsEntries = fsEntryRepo.getFSEntries(dealerId);
		for(FSEntry fsEntry : TCollectionUtils.nullSafeList(fsEntries)){
			oemFsMappingRepo.updateFsIdInOemFsMapping(fsEntry);
		}
	}

	@Override
	public void migrateOemFsCellCodeSnapshotsFromOemToFSLevel(String dealerId) {
		List<FSEntry> fsEntries = fsEntryRepo.getFSEntries(dealerId);
		for(FSEntry fsEntry : TCollectionUtils.nullSafeList(fsEntries)){
			oemFsCellCodeSnapshotRepo.updateFsIdInOemFsCellCodeSnapshots(fsEntry);
		}
	}

	@Override
	public void migrateOemFsMappingSnapshotsFromOemToFSLevel(String dealerId) {
		List<FSEntry> fsEntries = fsEntryRepo.getFSEntries(dealerId);
		for(FSEntry fsEntry : TCollectionUtils.nullSafeList(fsEntries)){
			oemFsMappingSnapshotRepo.updateFsIdInOemFsMappingSnapshots(fsEntry);
		}
	}

	@Override
	public void addFsTypeInOemFsCellCodeSnapshots(String dealerId) {
		List<FSEntry> fsEntries = fsEntryRepo.getFSEntries(dealerId);
		for(FSEntry fsEntry : TCollectionUtils.nullSafeList(fsEntries)){
			oemFsCellCodeSnapshotRepo.updateFsTypeInFsCellCodeSnapshots(fsEntry);
		}
	}

	private MonthInfo getActiveMonthInfo(){
		return accountingService.getActiveMonthInfo();
	}

	private int getFiscalYearStartMonth(){
		return accountingService.getAccountingSettings().getFiscalYearStartMonth();
	}

	private Map<Integer, Map<String, Map<String, BigDecimal>>> getGlBalCntInfoForFS(FsReportDto fsrContext){
		return accountingService.getGlBalCntInfoForFS(fsrContext);
	}
}



